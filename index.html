<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasking - Level Up Your Life</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        primary: {
                            DEFAULT: 'var(--color-primary)', 
                            hover: 'var(--color-primary-hover)',
                            light: 'var(--color-primary-light)', 
                        },
                        secondary: {
                            DEFAULT: '#84cc16', // Lime
                            hover: '#65a30d',
                        },
                        dark: {
                            bg: '#0f172a', 
                            surface: '#1e293b',
                            text: '#f8fafc',
                        },
                        light: {
                            bg: '#f8fafc',
                            surface: '#ffffff',
                            text: '#0f172a',
                        },
                        premium: {
                            DEFAULT: '#f59e0b',
                            light: '#fef3c7'
                        }
                    },
                    animation: {
                        'bounce-short': 'bounce 1s infinite 2',
                        'float-up': 'floatUp 1s ease-out forwards',
                    },
                    keyframes: {
                        floatUp: {
                            '0%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                            '100%': { opacity: '0', transform: 'translateY(-50px) scale(1.5)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* DEFINISI WARNA DINAMIS */
        :root {
            --color-primary: #6366f1;
            --color-primary-hover: #4f46e5;
            --color-primary-light: #e0e7ff;
        }

        .theme-pink { --color-primary: #ec4899; --color-primary-hover: #db2777; --color-primary-light: #fce7f3; }
        .theme-orange { --color-primary: #f97316; --color-primary-hover: #ea580c; --color-primary-light: #ffedd5; }
        .theme-teal { --color-primary: #14b8a6; --color-primary-hover: #0d9488; --color-primary-light: #ccfbf1; }
        .theme-blue { --color-primary: #3b82f6; --color-primary-hover: #2563eb; --color-primary-light: #dbeafe; }

        .dark .glass {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        body { transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .custom-select-wrapper { position: relative; user-select: none; }
        
        /* Effect for Epic Priority Change */
        @keyframes highlight-change {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.02); filter: brightness(1.1); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .priority-changed-anim { animation: highlight-change 0.8s ease-in-out; }
    </style>
</head>
<body class="bg-light-bg text-light-text dark:bg-dark-bg dark:text-dark-text min-h-screen flex flex-col font-sans selection:bg-primary selection:text-white">

    <!-- Decorative Blobs -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none opacity-40 dark:opacity-20">
        <div class="absolute top-0 left-1/4 w-72 h-72 bg-primary rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-72 h-72 bg-secondary rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-1/3 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-4000"></div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="flex flex-col h-screen overflow-hidden">
        
        <!-- Navbar -->
        <nav class="glass border-b border-gray-200/50 dark:border-gray-700/50 p-4 px-6 flex justify-between items-center z-20">
            <div class="flex items-center gap-2 sm:gap-6">
                <!-- BRANDING -->
                <div class="flex items-center gap-2 cursor-pointer group" onclick="location.reload()" title="Refresh / Home">
                    <div class="w-9 h-9 bg-white dark:bg-slate-800 text-primary rounded-xl flex items-center justify-center shadow-sm border border-gray-100 dark:border-slate-700 group-hover:scale-105 transition-transform">
                        <i class="fas fa-check-double"></i>
                    </div>
                    <h1 class="font-extrabold text-xl tracking-tight hidden md:block bg-clip-text text-transparent bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-400">Tasking</h1>
                </div>

                <!-- DIVIDER (Desktop only) -->
                <div class="hidden md:block h-6 w-px bg-gray-300 dark:bg-gray-700"></div>

                <!-- GAMIFICATION PROFILE -->
                <div class="flex items-center gap-3">
                    <div class="relative cursor-pointer" onclick="togglePremiumStatus()" title="Tap for Dev Mode (Secret)">
                        <!-- Added id="avatar-container" for dynamic border color -->
                        <div id="avatar-container" class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-xl flex items-center justify-center text-white font-extrabold text-sm shadow-md border-2 border-white dark:border-slate-700 transform rotate-2 hover:rotate-0 transition-all duration-300">
                            <span id="level-number">1</span>
                        </div>
                        <div class="absolute -bottom-1 -right-1 bg-yellow-400 text-[8px] font-black px-1 rounded text-black border border-white shadow-sm tracking-widest">LVL</div>
                    </div>
                    
                    <div class="hidden sm:flex flex-col">
                        <div class="flex items-center gap-1.5">
                            <h2 class="font-bold text-xs tracking-tight text-gray-800 dark:text-gray-100">
                                <span id="user-title">Novice Tasker</span>
                            </h2>
                            <span id="pro-badge" class="hidden text-[8px] bg-premium text-white px-1 py-0.5 rounded shadow-sm font-bold tracking-wider">PRO</span>
                        </div>
                        <!-- XP BAR -->
                        <div class="flex items-center gap-2 mt-0.5">
                            <div class="w-20 h-1.5 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                <div id="xp-bar" class="h-full bg-gradient-to-r from-primary to-purple-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <span id="xp-text" class="text-[8px] font-mono font-bold text-gray-400 leading-none">0 XP</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 items-center">
                <button onclick="openModal('modal-settings')" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-600 dark:text-gray-300 transition flex items-center justify-center" title="Pengaturan Tampilan">
                    <i class="fas fa-palette"></i>
                </button>
                <a href="about.html" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-600 dark:text-gray-300 transition flex items-center justify-center" title="About / Bantuan">
                    <i class="fas fa-question"></i>
                </a>
                <button onclick="openModal('modal-premium')" class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-500 text-white hover:scale-105 transition flex items-center justify-center shadow-lg shadow-yellow-500/30" title="Berlangganan Premium">
                    <i class="fas fa-crown"></i>
                </button>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
            
            <div class="max-w-5xl mx-auto">
                <!-- Header Actions -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-4">
                    <div>
                        <h1 class="text-4xl font-extrabold tracking-tight mb-2">Daftar Tugas</h1>
                        <!-- Clock & Date Section -->
                        <div class="flex flex-wrap items-center gap-3 text-gray-500 dark:text-gray-400 font-medium">
                            <div class="flex items-center gap-3 bg-gray-100 dark:bg-slate-800/50 px-4 py-2 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm transition-all hover:scale-105 cursor-default">
                                <span id="time-icon" class="text-2xl animate-pulse">‚òÄÔ∏è</span>
                                <span id="clock-display" class="font-mono text-xl tracking-wide text-gray-800 dark:text-gray-200 font-bold">00:00:00</span>
                            </div>
                            <span class="hidden md:inline text-gray-300 dark:text-gray-700 text-xl">|</span>
                            <span id="date-display" class="text-lg">Senin, 1 Januari 2024</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="openCategoryModal()" class="bg-primary-light text-primary hover:opacity-90 dark:bg-slate-800 dark:text-primary-light px-6 py-3 rounded-xl transition font-bold shadow-sm flex items-center gap-2" title="Kelola Kategori">
                            <i class="fas fa-folder-plus"></i> <span class="hidden sm:inline">Kategori</span>
                        </button>
                        <button onclick="openAddTaskModal()" class="bg-primary hover:bg-primary-hover text-white px-6 py-3 rounded-xl shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:-translate-y-1 transition-all duration-300 flex items-center gap-2 font-bold">
                            <i class="fas fa-plus"></i> Tambah Tugas
                        </button>
                    </div>
                </div>

                <!-- SLOT IKLAN (AD BANNER) - Business Requirement -->
                <!-- Iklan ini hanya muncul untuk user gratis -->
                <div id="ad-banner" class="mb-8 hidden animate-bounce-short">
                    <div class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 p-[2px] rounded-2xl">
                        <div class="bg-white dark:bg-slate-900 rounded-2xl p-4 flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="h-12 w-12 bg-yellow-100 text-yellow-600 rounded-xl flex items-center justify-center text-2xl shrink-0">
                                    üì¢
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] font-bold bg-gray-200 dark:bg-slate-700 px-1.5 py-0.5 rounded text-gray-500">ADS</span>
                                        <h4 class="font-bold text-sm sm:text-base text-gray-800 dark:text-white">Promo Spesial Mahasiswa!</h4>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Dapatkan diskon 50% untuk kursus coding di <span class="underline decoration-primary cursor-pointer hover:text-primary">EduTech Partner</span>.</p>
                                </div>
                            </div>
                            <button onclick="openModal('modal-premium')" class="whitespace-nowrap text-xs font-bold text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 transition flex items-center gap-1 group">
                                <i class="fas fa-ban group-hover:scale-110 transition"></i> Hapus Iklan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabs & Filter -->
                <div class="flex flex-col md:flex-row justify-between items-center bg-white dark:bg-dark-surface p-2 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-8 gap-4">
                    <div class="flex bg-gray-100 dark:bg-slate-900 p-1 rounded-xl w-full md:w-auto">
                        <button onclick="switchView('list')" id="btn-view-list" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white dark:bg-slate-700 text-primary">List Tugas</button>
                        <button onclick="switchView('folder')" id="btn-view-folder" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Kategori</button>
                        <button onclick="switchView('calendar')" id="btn-view-calendar" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Kalender</button>
                    </div>
                    
                    <div id="filter-container" class="flex gap-3 items-center w-full md:w-auto px-2 relative z-30 transition-all duration-500 ease-in-out transform origin-right">
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Sort By:</span>
                        <div class="flex-1 md:w-48">
                             <select id="filter-sort" onchange="renderTasks()">
                                <option value="deadline">Deadline Terdekat</option>
                                <option value="alpha">Abjad (A-Z)</option>
                                <!-- Option 'Tugas Terbanyak' will be injected here via JS if needed -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- LIST VIEW -->
                <div id="view-list" class="transition-all duration-500 ease-in-out transform origin-top"></div>

                <!-- CALENDAR VIEW -->
                <div id="view-calendar" class="hidden bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 transition-all duration-500 ease-in-out transform origin-top opacity-0 scale-95">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2">
                            <button onclick="changeMonth(-1)" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center justify-center transition"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="calendar-month-year" class="font-bold text-xl min-w-[140px] text-center">Januari 2024</h3>
                            <button onclick="changeMonth(1)" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center justify-center transition"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <a href="https://calendar.google.com/" target="_blank" class="text-xs font-bold text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary transition flex items-center gap-2 bg-gray-50 dark:bg-slate-800 px-3 py-2 rounded-lg border border-gray-200 dark:border-slate-700">
                            <i class="fab fa-google"></i> Buka GCal
                        </a>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">
                        <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
                    </div>
                    <div id="calendar-body" class="calendar-grid"></div>
                    <div class="mt-6 flex gap-4 text-xs font-medium justify-center">
                         <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-400"></span> Tinggi</div>
                         <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-400"></span> Sedang</div>
                         <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-400"></span> Rendah</div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL: SETTINGS -->
    <div id="modal-settings" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-sm rounded-2xl shadow-2xl p-6 border border-gray-100 dark:border-gray-700 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Tampilan</h3>
                <button onclick="closeModal('modal-settings')" class="text-gray-400 hover:text-black dark:hover:text-white"><i class="fas fa-times"></i></button>
            </div>

            <!-- Dark Mode Toggle -->
            <div class="flex justify-between items-center mb-6 p-4 bg-gray-50 dark:bg-slate-800 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-700 flex items-center justify-center shadow-sm">
                        <i id="theme-modal-icon" class="fas fa-moon text-primary"></i>
                    </div>
                    <div>
                        <p class="font-bold text-sm">Mode Gelap</p>
                        <p class="text-xs text-gray-500">Nyaman di mata</p>
                    </div>
                </div>
                <button onclick="toggleTheme()" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-primary transition-colors">
                    <span class="sr-only">Toggle dark mode</span>
                    <span id="dark-mode-toggle-circle" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1 dark:translate-x-6"></span>
                </button>
            </div>

            <!-- Color Theme Picker -->
            <div>
                <div class="flex justify-between items-center mb-3">
                    <p class="font-bold text-sm">Warna Tema</p>
                    <span class="text-[10px] bg-premium text-white px-2 py-0.5 rounded font-bold">PRO</span>
                </div>
                <div class="grid grid-cols-4 gap-3">
                    <button onclick="changeColorTheme('')" class="h-10 rounded-full bg-[#6366f1] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 focus:ring-black dark:ring-offset-slate-800"></button>
                    <button onclick="changeColorTheme('theme-pink')" class="h-10 rounded-full bg-[#ec4899] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 focus:ring-black dark:ring-offset-slate-800"></button>
                    <button onclick="changeColorTheme('theme-orange')" class="h-10 rounded-full bg-[#f97316] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 focus:ring-black dark:ring-offset-slate-800"></button>
                    <button onclick="changeColorTheme('theme-teal')" class="h-10 rounded-full bg-[#14b8a6] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 focus:ring-black dark:ring-offset-slate-800"></button>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">Pilih warna aksen favoritmu.</p>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD CATEGORY -->
    <div id="modal-category" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-sm rounded-2xl shadow-2xl p-6 border border-gray-100 dark:border-gray-700 transform transition-all scale-100 relative overflow-hidden">
            <!-- Premium Banner -->
            <div id="premium-category-banner" class="hidden absolute top-0 left-0 right-0 bg-premium text-white text-xs font-bold text-center py-1">
                Kategori Penuh (3/3). Upgrade ke PRO!
            </div>

            <h3 class="text-xl font-bold mb-4 mt-2">Kelola Kategori</h3>
            <p id="category-limit-info" class="text-xs text-gray-500 mb-3">User Gratis: Maksimal 3 Kategori.</p>
            
            <div id="current-categories" class="flex flex-wrap gap-2 mb-4 max-h-32 overflow-y-auto"></div>
            
            <form id="add-category-form" class="mt-2">
                <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Kategori Baru</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="new-category-input" class="flex-1 p-2 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none transition font-medium text-sm" placeholder="Misal: Biologi" required>
                    <button type="submit" class="bg-black text-white dark:bg-white dark:text-black p-2 rounded-xl hover:opacity-80"><i class="fas fa-plus"></i></button>
                </div>
            </form>
            
            <button onclick="closeModal('modal-category')" class="w-full mt-4 py-2 text-gray-500 hover:text-black dark:hover:text-white font-bold text-sm">Tutup</button>
        </div>
    </div>

    <!-- MODAL: PREMIUM UPSELL -->
    <div id="modal-premium" class="fixed inset-0 z-[110] hidden bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-sm rounded-3xl shadow-2xl p-8 border-2 border-premium transform transition-all scale-100 text-center relative">
            <button onclick="closeModal('modal-premium')" class="absolute top-4 right-4 text-gray-400 hover:text-black dark:hover:text-white"><i class="fas fa-times"></i></button>
            
            <div class="w-16 h-16 bg-premium/20 text-premium rounded-full flex items-center justify-center mx-auto mb-4 text-3xl animate-bounce-short">
                <i class="fas fa-crown"></i>
            </div>
            
            <h2 class="text-2xl font-black mb-2 text-gray-900 dark:text-white">Upgrade ke PRO</h2>
            <p class="text-gray-500 text-sm mb-6">Buka potensi penuh produktivitasmu.</p>
            
            <ul class="text-left space-y-3 mb-8 text-sm text-gray-600 dark:text-gray-300">
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Kategori Tanpa Batas</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Tema Warna Eksklusif</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Statistik Produktivitas</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Mode Fokus (Pomodoro)</li>
            </ul>
            
            <button onclick="activatePremium()" class="w-full py-3 bg-premium hover:bg-yellow-600 text-white font-bold rounded-xl shadow-lg shadow-premium/30 transition transform hover:scale-105">
                Dapatkan PRO - Rp 10.000/bln
            </button>
        </div>
    </div>

    <!-- MODAL: ADD TASK -->
    <div id="modal-add" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-lg rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700 transform transition-all scale-100 flex flex-col max-h-[90vh]">
            <div class="p-8 pb-4 flex justify-between items-center border-b border-gray-100 dark:border-gray-700 bg-white dark:bg-dark-surface rounded-t-2xl z-10 shrink-0">
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-purple-600">Tugas Baru ‚ú®</h2>
                <button onclick="closeModal('modal-add')" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-8 pt-4 overflow-y-auto custom-scrollbar flex-1">
                <form id="add-task-form" class="space-y-5">
                    <div>
                        <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Judul Tugas</label>
                        <input type="text" id="task-title" required class="w-full mt-2 p-3 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none transition font-medium" placeholder="Contoh: Makalah Sejarah">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Kategori</label>
                            <div class="mt-2">
                                <select id="task-category" required class="w-full">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Deadline</label>
                            <input type="datetime-local" id="task-deadline" required onchange="updatePriorityPreview()" class="w-full mt-2 p-3 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none transition cursor-pointer font-medium dark:[color-scheme:dark]">
                        </div>
                    </div>

                    <div class="bg-primary/5 border border-primary/20 p-4 rounded-xl flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center shadow-sm">
                            <i class="fas fa-chart-line text-primary"></i>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Prioritas</p>
                            <p id="priority-preview" class="font-bold text-gray-700 dark:text-gray-200">Pilih deadline dulu...</p>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Catatan</label>
                        <textarea id="task-notes" rows="3" class="w-full mt-2 p-3 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none resize-none font-medium" placeholder="Detail tugas..."></textarea>
                    </div>

                    <div class="pt-4 flex justify-end gap-3">
                        <button type="button" onclick="closeModal('modal-add')" class="px-6 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-800 transition">Batal</button>
                        <button type="submit" class="px-8 py-3 bg-primary hover:bg-primary-hover text-white font-bold rounded-xl shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:-translate-y-1 transition-all">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: TASK DETAIL -->
    <div id="modal-detail" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-md rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700 flex flex-col max-h-[90vh]">
            
            <!-- Sticky Header -->
            <div class="p-6 pb-2 flex justify-between items-start border-b border-transparent shrink-0">
                <span id="detail-category" class="text-[10px] font-bold uppercase tracking-widest bg-primary/10 text-primary px-3 py-1 rounded-full">Kategori</span>
                <button onclick="closeModal('modal-detail')" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- Scrollable Content -->
            <div class="px-6 py-2 overflow-y-auto custom-scrollbar flex-1">
                <h2 id="detail-title" class="text-3xl font-extrabold mb-3 leading-tight break-words">Judul Tugas</h2>
                
                <div class="flex flex-wrap gap-4 mb-6 text-sm text-gray-500 dark:text-gray-400">
                    <div id="detail-deadline-wrapper" class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 px-3 py-1.5 rounded-lg transition-colors">
                        <i class="far fa-clock text-primary"></i> <span id="detail-deadline" class="font-medium">Deadline</span>
                    </div>
                    <div id="detail-priority-badge" class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 px-3 py-1.5 rounded-lg border border-transparent transition-colors">
                        <i id="detail-priority-icon" class="fas fa-flag text-primary"></i> <span id="detail-priority" class="font-bold">Prioritas</span>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-slate-900 p-5 rounded-2xl mb-2 border border-gray-100 dark:border-slate-800">
                    <p id="detail-notes" class="text-sm whitespace-pre-wrap break-words leading-relaxed text-gray-600 dark:text-gray-300">Tidak ada catatan.</p>
                </div>
            </div>

            <!-- Sticky Footer Actions -->
            <div class="p-6 pt-4 space-y-3 bg-white dark:bg-dark-surface rounded-b-2xl shrink-0">
                <button id="btn-gcal" class="w-full bg-white dark:bg-slate-800 border-2 border-gray-200 dark:border-slate-700 text-gray-700 dark:text-gray-200 py-3.5 rounded-xl font-bold hover:bg-gray-50 dark:hover:bg-slate-700 transition flex items-center justify-center gap-2 group">
                    <i class="fab fa-google text-blue-500 group-hover:scale-110 transition"></i> Add to Google Calendar
                </button>
                <button id="btn-complete" class="w-full bg-secondary hover:bg-secondary-hover text-white py-4 rounded-xl font-bold shadow-lg shadow-secondary/30 hover:shadow-secondary/50 hover:-translate-y-1 transition-all flex items-center justify-center gap-2 text-lg">
                    <i class="fas fa-check-circle"></i> Mark as Done
                </button>
                <button id="btn-delete" class="w-full text-red-400 text-sm py-2 hover:text-red-600 transition font-medium">
                    Hapus Tugas
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: CELEBRATION -->
    <div id="modal-celebration" class="fixed inset-0 z-50 hidden bg-slate-900/90 backdrop-blur flex items-center justify-center p-4 text-center">
        <div class="transform transition-all animate-bounce-short">
            <div class="text-8xl mb-6 filter drop-shadow-lg">üéâ</div>
            <div class="text-3xl font-black text-yellow-400 mb-2 mt-4 drop-shadow-md" id="xp-gain-anim">+100 XP</div>
            <h2 class="text-4xl font-black mb-3 text-white">Level Up! üî•</h2>
            <p id="celebration-msg" class="text-gray-300 mb-8 text-xl font-medium max-w-xs mx-auto">Tugas selesai.</p>
            <button onclick="closeCelebration()" class="px-10 py-4 bg-white text-primary font-bold rounded-full hover:scale-105 transition shadow-xl shadow-white/20">Lanjut Gan!</button>
        </div>
    </div>

    <script>
        // CONFIG
        const PRIORITY_STYLES = {
            tinggi: { badge: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 border-red-200", dot: "bg-red-500", strip: "bg-red-500", label: "TINGGI" },
            sedang: { badge: "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400 border-yellow-200", dot: "bg-yellow-500", strip: "bg-yellow-500", label: "SEDANG" },
            rendah: { badge: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border-green-200", dot: "bg-green-500", strip: "bg-green-500", label: "RENDAH" },
            telat: { badge: "bg-rose-600 text-white dark:bg-rose-700 border-rose-700", dot: "bg-white animate-pulse", strip: "bg-rose-600", label: "TELAT" }
        };

        const state = {
            tasks: JSON.parse(localStorage.getItem('focusTask_tasks')) || [],
            categories: JSON.parse(localStorage.getItem('focusTask_categories')) || ['Umum'],
            darkMode: localStorage.getItem('focusTask_theme') === 'dark',
            colorTheme: localStorage.getItem('focusTask_color') || '',
            viewMode: 'list', 
            currentDate: new Date(),
            currentTaskView: null,
            isPremium: localStorage.getItem('focusTask_premium') === 'true',
            // GAMIFICATION STATE
            xp: parseInt(localStorage.getItem('focusTask_xp')) || 0,
            level: parseInt(localStorage.getItem('focusTask_level')) || 1
        };

        const els = {
            mainApp: document.getElementById('main-app'),
            addTaskForm: document.getElementById('add-task-form'),
            taskList: document.getElementById('view-list'),
            calendarView: document.getElementById('view-calendar'),
            calendarBody: document.getElementById('calendar-body'),
            dateDisplay: document.getElementById('date-display'),
            filterSort: document.getElementById('filter-sort'),
        };

        // --- GAMIFICATION LOGIC ---
        // Define Titles based on Level
        const TITLES = [
            { lvl: 1, name: "Novice Tasker", color: "border-gray-200" },
            { lvl: 3, name: "Apprentice", color: "border-green-400" },
            { lvl: 5, name: "Productivity Pro", color: "border-blue-400" },
            { lvl: 10, name: "Task Master", color: "border-purple-400" },
            { lvl: 20, name: "Grandmaster", color: "border-yellow-400" },
            { lvl: 50, name: "Godlike", color: "border-red-500" }
        ];

        function getTitleData(level) {
            return TITLES.slice().reverse().find(t => level >= t.lvl) || TITLES[0];
        }

        function updateXPDisplay() {
            const levelEl = document.getElementById('level-number');
            const titleEl = document.getElementById('user-title');
            const avatarContainer = document.getElementById('avatar-container');
            const xpText = document.getElementById('xp-text');
            const xpBar = document.getElementById('xp-bar');
            
            const nextLevelXP = state.level * 500;
            const progress = (state.xp / nextLevelXP) * 100;
            const currentTitleData = getTitleData(state.level);

            levelEl.textContent = state.level;
            titleEl.textContent = currentTitleData.name;
            
            avatarContainer.className = avatarContainer.className.replace(/border-\w+-\d+/g, '');
            avatarContainer.classList.add(currentTitleData.color); 
            if(!avatarContainer.classList.contains('border-4')) avatarContainer.classList.add('border-4');


            xpText.textContent = `${state.xp}/${nextLevelXP} XP`;
            xpBar.style.width = `${Math.min(progress, 100)}%`;
        }

        function addXP(amount) {
            state.xp += amount;
            const nextLevelXP = state.level * 500;
            
            if (state.xp >= nextLevelXP) {
                state.level++;
                state.xp -= nextLevelXP; 
                
                const newTitle = getTitleData(state.level);
                alert(`LEVEL UP! Selamat datang di Level ${state.level} üéâ\nGelar Baru: ${newTitle.name}`);
            }
            
            localStorage.setItem('focusTask_xp', state.xp);
            localStorage.setItem('focusTask_level', state.level);
            updateXPDisplay();
        }

        // ... FREEMIUM & THEME Logic ...
        function checkPremiumFeature(featureName) {
            if (state.isPremium) return true;
            if (featureName === 'add_category' && state.categories.length >= 3) { openModal('modal-premium'); return false; }
            if (featureName === 'custom_theme') { openModal('modal-premium'); return false; }
            return true;
        }
        function activatePremium() {
            alert("Terima kasih! Anda sekarang user PRO. üéâ");
            state.isPremium = true;
            localStorage.setItem('focusTask_premium', 'true');
            closeModal('modal-premium');
            updateUIForPremium();
            if (!document.getElementById('modal-category').classList.contains('hidden')) {
                openCategoryModal();
            }
        }

        function updateUIForPremium() {
            const badge = document.getElementById('pro-badge');
            const limitInfo = document.getElementById('category-limit-info');
            const banner = document.getElementById('premium-category-banner');
            const adBanner = document.getElementById('ad-banner'); // Referensi ke elemen iklan

            if (state.isPremium) {
                if (badge) badge.classList.remove('hidden');
                if (limitInfo) limitInfo.textContent = "User PRO: Kategori Tanpa Batas ‚ú®";
                if (banner) banner.classList.add('hidden');
                if (adBanner) adBanner.classList.add('hidden'); // Sembunyikan iklan jika Premium
            } else {
                if (badge) badge.classList.add('hidden');
                if (state.categories.length >= 3 && banner) banner.classList.remove('hidden');
                if (adBanner) adBanner.classList.remove('hidden'); // Tampilkan iklan jika Gratis
            }
        }
        function togglePremiumStatus() {
            if(confirm("Dev Mode: Toggle Premium Status?")) {
                state.isPremium = !state.isPremium;
                localStorage.setItem('focusTask_premium', state.isPremium);
                location.reload();
            }
        }
        function changeColorTheme(themeName) {
            if (themeName && !checkPremiumFeature('custom_theme')) return;
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            if (themeName) document.body.classList.add(themeName);
            state.colorTheme = themeName;
            localStorage.setItem('focusTask_color', themeName);
        }

        // ... CUSTOM SELECT ...
        function initCustomSelects() {
             document.querySelectorAll('.custom-select-wrapper').forEach(w => {
                const s = w.querySelector('select');
                if(s) { w.parentNode.insertBefore(s, w); s.style.display = 'block'; s.removeAttribute('data-customized'); }
                w.remove();
            });
            document.querySelectorAll('select').forEach(select => {
                if (select.dataset.customized === 'true') return;
                select.style.display = 'none';
                select.dataset.customized = 'true';
                const wrapper = document.createElement('div');
                wrapper.className = 'custom-select-wrapper relative w-full font-medium select-none';
                const trigger = document.createElement('div');
                trigger.className = "flex justify-between items-center cursor-pointer bg-gray-50 dark:bg-slate-900 border-2 border-transparent hover:border-primary/50 transition-all rounded-xl p-3 px-4 text-sm w-full outline-none";
                const displayText = select.options[select.selectedIndex] ? select.options[select.selectedIndex].text : "Pilih...";
                trigger.innerHTML = `<span class="truncate text-gray-700 dark:text-gray-200">${displayText}</span><i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-300"></i>`;
                const optionsDiv = document.createElement('div');
                optionsDiv.className = "absolute left-0 right-0 top-full mt-2 bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl shadow-xl z-[100] overflow-hidden hidden opacity-0 transform scale-95 transition-all duration-200 origin-top max-h-60 overflow-y-auto custom-scrollbar";
                
                const toggleMenu = (forceState) => {
                     if (forceState !== false) {
                         document.querySelectorAll('.custom-dropdown-options').forEach(el => {
                             if(el !== optionsDiv) {
                                 el.classList.add('hidden', 'opacity-0', 'scale-95');
                                 const otherTrigger = el.parentElement.querySelector('.fa-chevron-down');
                                 if(otherTrigger) otherTrigger.classList.remove('rotate-180');
                             }
                         });
                    }
                    let isOpen = !optionsDiv.classList.contains('hidden');
                    if (forceState !== undefined) isOpen = !forceState; 
                    
                    if (!isOpen) { 
                        optionsDiv.classList.remove('hidden');
                        requestAnimationFrame(() => {
                            optionsDiv.classList.remove('opacity-0', 'scale-95');
                            optionsDiv.classList.add('opacity-100', 'scale-100');
                        });
                        trigger.querySelector('.fa-chevron-down').classList.add('rotate-180');
                        trigger.classList.add('border-primary/50', 'ring-2', 'ring-primary/20'); 
                    } else { 
                        optionsDiv.classList.remove('opacity-100', 'scale-100');
                        optionsDiv.classList.add('opacity-0', 'scale-95');
                        trigger.querySelector('.fa-chevron-down').classList.remove('rotate-180');
                        trigger.classList.remove('border-primary/50', 'ring-2', 'ring-primary/20');
                        setTimeout(() => {
                            if (optionsDiv.classList.contains('opacity-0')) optionsDiv.classList.add('hidden');
                        }, 200);
                    }
                };

                Array.from(select.options).forEach(option => {
                    const div = document.createElement('div');
                    div.className = "px-4 py-3 cursor-pointer hover:bg-primary/10 hover:text-primary dark:hover:bg-slate-700 transition-colors text-sm text-gray-600 dark:text-gray-300 flex items-center justify-between";
                    div.innerHTML = `<span>${option.text}</span>`;
                    if (option.selected) div.classList.add('text-primary', 'bg-primary/5', 'font-bold');
                    div.addEventListener('click', (e) => {
                        e.stopPropagation();
                        select.value = option.value;
                        select.dispatchEvent(new Event('change'));
                        trigger.querySelector('span').textContent = option.text;
                        toggleMenu(false);
                    });
                    optionsDiv.appendChild(div);
                });

                trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMenu();
                });

                optionsDiv.classList.add('custom-dropdown-options');
                select.parentNode.insertBefore(wrapper, select);
                wrapper.appendChild(select);
                wrapper.appendChild(trigger);
                wrapper.appendChild(optionsDiv);
                
                document.addEventListener('click', (e) => {
                    if (!wrapper.contains(e.target)) {
                        toggleMenu(false);
                    }
                });
            });
        }

        // ... MAIN INIT ...
        function init() {
            applyTheme();
            if (state.colorTheme) document.body.classList.add(state.colorTheme);
            renderDate();
            showMainApp();
            setInterval(updateClockAndIcon, 1000);
            updateClockAndIcon();
            updateUIForPremium(); 
            startRealTimePriorityCheck();
            updateXPDisplay(); // Init XP
        }

        // ... REALTIME CHECK ...
        function startRealTimePriorityCheck() {
            setInterval(() => {
                let changed = false;
                state.tasks.forEach(task => {
                    if (task.completed) return;
                    const newPrio = calculatePriority(task.deadline);
                    if (newPrio !== task.priority) {
                        task.priority = newPrio;
                        changed = true;
                        animatePriorityChange(task.id, newPrio);
                    }
                });
                if (changed) saveTasks();
            }, 1000);
        }

        function animatePriorityChange(id, newPrio) {
            const card = document.getElementById(`task-${id}`);
            if (!card) return;

            const styles = PRIORITY_STYLES[newPrio];
            
            // Elements to update
            const strip = card.querySelector('.priority-strip');
            const badge = card.querySelector('.priority-badge');
            const dot = card.querySelector('.priority-dot');
            const label = card.querySelector('.priority-label');
            const footer = card.querySelector('.priority-footer'); // For late text color

            // Apply transition class
            [strip, badge, dot, footer].forEach(el => {
                if(el) el.classList.add('priority-changed-anim');
            });

            // Update classes
            if(strip) strip.className = `priority-strip absolute left-0 top-4 bottom-4 w-1.5 rounded-r-lg transition-colors duration-1000 ${styles.strip}`;
            if(badge) badge.className = `priority-badge inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide transition-colors duration-1000 ${styles.badge}`;
            if(dot) dot.className = `priority-dot w-1.5 h-1.5 rounded-full transition-colors duration-1000 ${styles.dot}`;
            if(label) label.textContent = styles.label;

            // Late text update
            if(footer) {
                if(newPrio === 'telat') {
                    footer.className = "priority-footer pt-4 border-t border-gray-100 dark:border-gray-700 flex items-center gap-2 text-rose-600 dark:text-rose-400 font-bold text-sm transition-colors duration-1000";
                } else {
                    footer.className = "priority-footer pt-4 border-t border-gray-100 dark:border-gray-700 flex items-center gap-2 text-gray-500 dark:text-gray-400 text-sm font-medium transition-colors duration-1000";
                }
            }

            // Remove anim class
            setTimeout(() => {
                 [strip, badge, dot, footer].forEach(el => {
                    if(el) el.classList.remove('priority-changed-anim');
                });
            }, 1000);
        }

        function updateClockAndIcon() {
            const now = new Date();
            const hour = now.getHours();
            document.getElementById('clock-display').textContent = now.toLocaleTimeString('id-ID', { hour12: false });
            let icon = 'üåô'; 
            if (hour >= 5 && hour < 11) icon = 'üåÖ'; 
            else if (hour >= 11 && hour < 15) icon = '‚òÄÔ∏è'; 
            else if (hour >= 15 && hour < 18) icon = 'üåá'; 
            else if (hour >= 18 || hour < 5) icon = 'üåô'; 
            document.getElementById('time-icon').textContent = icon;
        }

        function applyTheme() {
            const html = document.documentElement;
            state.darkMode ? html.classList.add('dark') : html.classList.remove('dark');
            const modalIcon = document.getElementById('theme-modal-icon');
            if (modalIcon) {
                state.darkMode ? modalIcon.classList.replace('fa-moon', 'fa-sun') : modalIcon.classList.replace('fa-sun', 'fa-moon');
            }
        }

        function renderDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            els.dateDisplay.textContent = new Date().toLocaleDateString('id-ID', options);
        }

        function showMainApp() {
            els.mainApp.classList.remove('hidden');
            els.mainApp.classList.add('flex');
            renderTasks();
            renderCalendar();
            setTimeout(initCustomSelects, 100); 
        }

        function openCategoryModal() { renderCategoryBadges(); updateUIForPremium(); openModal('modal-category'); }

        function renderCategoryBadges() {
            const container = document.getElementById('current-categories');
            container.innerHTML = state.categories.length === 0 ? '<span class="text-xs text-gray-400 italic">Belum ada kategori</span>' : '';
            state.categories.forEach(cat => {
                const badge = document.createElement('div');
                badge.className = "bg-gray-100 dark:bg-slate-800 text-xs px-3 py-1 rounded-full flex items-center gap-2 border border-gray-200 dark:border-slate-700 select-none group hover:border-red-200 dark:hover:border-red-900 transition-colors";
                badge.innerHTML = `<span>${cat}</span><button type="button" class="text-gray-400 group-hover:text-red-500 transition-colors cursor-pointer"><i class="fas fa-times"></i></button>`;
                badge.querySelector('button').onclick = (e) => { e.preventDefault(); deleteCategory(cat); };
                container.appendChild(badge);
            });
        }

        function deleteCategory(cat) {
            const origLen = state.categories.length;
            state.categories = state.categories.filter(c => c !== cat);
            if (state.categories.length < origLen) {
                localStorage.setItem('focusTask_categories', JSON.stringify(state.categories));
                renderCategoryBadges(); renderCategoryOptions(); renderTasks(); updateUIForPremium(); 
            }
        }

        document.getElementById('add-category-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!checkPremiumFeature('add_category')) return;
            const input = document.getElementById('new-category-input');
            const newCat = input.value.trim();
            if (newCat && !state.categories.includes(newCat)) {
                state.categories.push(newCat);
                localStorage.setItem('focusTask_categories', JSON.stringify(state.categories));
                input.value = '';
                renderCategoryBadges(); renderCategoryOptions(); renderTasks(); updateUIForPremium();
            }
        });

        function renderCategoryOptions() {
            const select = document.getElementById('task-category');
            if (!select) return;
            select.innerHTML = '';
            
            // FIX: Ensure there's a default selection if available
            state.categories.forEach((cat, index) => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (index === 0) option.selected = true; // Select first by default
                select.appendChild(option);
            });
            
            // Trigger update
            if (state.categories.length > 0) {
                select.value = state.categories[0];
            }

            initCustomSelects();
        }

        function calculatePriority(d) {
            if(!d) return 'sedang';
            const now = new Date();
            const deadline = new Date(d);
            if (now > deadline) return 'telat';
            const diff = (deadline - now) / (1000 * 60 * 60 * 24);
            return diff < 3 ? 'tinggi' : (diff <= 7 ? 'sedang' : 'rendah');
        }

        function updatePriorityPreview() {
            const val = document.getElementById('task-deadline').value;
            const el = document.getElementById('priority-preview');
            if(!val) { el.textContent = "Pilih deadline dulu..."; el.className = "font-bold text-gray-700 dark:text-gray-200"; return; }
            const p = calculatePriority(val);
            const style = PRIORITY_STYLES[p];
            let c = "text-green-500";
            if(p === 'tinggi') c = "text-red-500";
            if(p === 'sedang') c = "text-yellow-500";
            if(p === 'telat') c = "text-rose-600";
            
            el.textContent = style.label + (p==='telat'?' ‚ö†Ô∏è':''); 
            el.className = `font-bold ${c}`;
        }

        els.addTaskForm.addEventListener('submit', (e) => {
            e.preventDefault();

             // FIX: Validasi Manual Kategori
            const titleVal = document.getElementById('task-title').value;
            const categoryVal = document.getElementById('task-category').value;
            const deadlineVal = document.getElementById('task-deadline').value;

            if (!titleVal) { alert("Judul tugas harus diisi!"); return; }
            if (!categoryVal) { alert("Mohon pilih kategori!"); return; }
            if (!deadlineVal) { alert("Deadline harus diisi!"); return; }

            const autoPriority = calculatePriority(deadlineVal);

            const newTask = {
                id: Date.now(),
                title: titleVal,
                category: categoryVal,
                priority: autoPriority, 
                deadline: deadlineVal,
                notes: document.getElementById('task-notes').value,
                completed: false,
                createdAt: new Date().toISOString(),
                sentAlerts: [] 
            };
            state.tasks.push(newTask);
            saveTasks();
            renderTasks();
            renderCalendar();
            closeModal('modal-add');
            els.addTaskForm.reset();
            updatePriorityPreview(); 
        });

        function saveTasks() { localStorage.setItem('focusTask_tasks', JSON.stringify(state.tasks)); }

        function renderTasks() {
            const container = els.taskList;
            container.innerHTML = '';
            let tasks = state.tasks.filter(t => !t.completed);
            const sort = els.filterSort.value;

            if (tasks.length === 0 && state.viewMode !== 'folder') {
                container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 transition-all duration-500 ease-in-out transform origin-top";
                container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400"><div class="w-24 h-24 bg-gray-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4 text-4xl animate-bounce">üåµ</div><p class="font-medium">Belum ada tugas. Chill dulu!</p></div>`;
                return;
            }

            if (state.viewMode === 'folder') {
                container.className = "space-y-8 transition-all duration-500 ease-in-out transform origin-top pb-12"; 
                let cats = [...new Set([...state.categories, ...tasks.map(t => t.category)])].sort();
                
                // Sort Categories
                cats.sort((a, b) => {
                    if (sort === 'alpha') return a.localeCompare(b);
                    if (sort === 'most_tasks') {
                        const countA = tasks.filter(t => t.category === a).length;
                        const countB = tasks.filter(t => t.category === b).length;
                        return countB - countA;
                    }
                    if (sort === 'deadline') {
                        const tasksA = tasks.filter(t => t.category === a);
                        const minA = tasksA.length ? Math.min(...tasksA.map(t => new Date(t.deadline))) : Infinity;
                        const tasksB = tasks.filter(t => t.category === b);
                        const minB = tasksB.length ? Math.min(...tasksB.map(t => new Date(t.deadline))) : Infinity;
                        return minA - minB;
                    }
                    return 0;
                });

                cats.forEach(cat => {
                    const tInCat = tasks.filter(t => t.category === cat);
                    // Sort inside folder
                    tInCat.sort((a,b) => sort === 'deadline' ? new Date(a.deadline) - new Date(b.deadline) : a.title.localeCompare(b.title));
                    
                    const sec = document.createElement('div');
                    sec.className = "mb-8 border border-gray-200 dark:border-gray-700 rounded-3xl p-6 bg-white/50 dark:bg-slate-800/30";
                    sec.innerHTML = `<div class="bg-white dark:bg-dark-surface p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center justify-between mb-6 transition-all hover:shadow-md cursor-default"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-2xl bg-[#e0e7ff] dark:bg-slate-700/50 text-primary flex items-center justify-center text-xl"><i class="fas fa-folder"></i></div><h3 class="font-bold text-lg text-gray-800 dark:text-white">${cat}</h3></div><div class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 flex items-center justify-center font-bold text-sm">${tInCat.length}</div></div><div class="grid-container grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 pl-2"></div>`;
                    const gc = sec.querySelector('.grid-container');
                    if(tInCat.length > 0) tInCat.forEach(t => gc.appendChild(createTaskCard(t)));
                    else { gc.className = "flex items-center justify-center py-8 bg-gray-50 dark:bg-slate-800/30 rounded-xl border-2 border-dashed border-gray-200 dark:border-slate-700/50"; gc.innerHTML = `<span class="text-sm text-gray-400 italic">Belum ada tugas di kategori ini</span>`; }
                    container.appendChild(sec);
                });
            } else {
                container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 transition-all duration-500 ease-in-out transform origin-top";
                tasks.sort((a,b) => sort === 'deadline' ? new Date(a.deadline) - new Date(b.deadline) : a.title.localeCompare(b.title));
                tasks.forEach(t => container.appendChild(createTaskCard(t)));
            }
        }

        // Helper to create card DOM
        function createTaskCard(t) {
            const d = new Date(t.deadline);
            const dateStr = d.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' });
            const timeStr = d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }).replace('.', ':');
            
            const styles = PRIORITY_STYLES[t.priority];
            // Determine footer text color (Late is red)
            const footerColor = t.priority === 'telat' ? 'text-rose-600 dark:text-rose-400 font-bold' : 'text-gray-500 dark:text-gray-400';

            const c = document.createElement('div');
            c.id = `task-${t.id}`; 
            c.className = "bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition-all duration-300 cursor-pointer group flex flex-col justify-between relative overflow-hidden";
            c.onclick = () => openTaskDetail(t.id);
            
            // Priority Strip
            const strip = document.createElement('div');
            strip.className = `priority-strip absolute left-0 top-4 bottom-4 w-1.5 rounded-r-lg transition-colors duration-1000 ${styles.strip}`;
            c.appendChild(strip);

            c.innerHTML += `
                <div class="pl-4">
                    <div class="flex justify-between items-start mb-4">
                        <span class="inline-block px-3 py-1 rounded-lg bg-[#e0e7ff] dark:bg-indigo-900/30 text-primary font-bold text-[10px] tracking-wider uppercase">
                            ${t.category}
                        </span>
                        <span class="priority-badge inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide transition-colors duration-1000 ${styles.badge}">
                            <span class="priority-dot w-1.5 h-1.5 rounded-full transition-colors duration-1000 ${styles.dot}"></span> <span class="priority-label">${styles.label}</span>
                        </span>
                    </div>
                    <h3 class="font-extrabold text-xl text-gray-800 dark:text-gray-100 mb-6 leading-tight group-hover:text-primary transition-colors">
                        ${t.title}
                    </h3>
                </div>
                <div class="priority-footer pt-4 border-t border-gray-100 dark:border-gray-700 flex items-center gap-2 ${footerColor} text-sm font-medium transition-colors duration-1000">
                    <i class="far fa-clock"></i>
                    <span>${dateStr}, ${timeStr}</span>
                </div>
            `;
            return c;
        }

        function openTaskDetail(id) {
            const t = state.tasks.find(x => x.id === id);
            if (!t) return;
            state.currentTaskView = t;
            
            const currentPrio = calculatePriority(t.deadline); 
            const styles = PRIORITY_STYLES[currentPrio];
            
            const badge = document.getElementById('detail-priority-badge');
            const icon = document.getElementById('detail-priority-icon');
            const text = document.getElementById('detail-priority');

            // Map styles to modal classes (simplified mapping from card styles to modal styles)
            let badgeClass = "bg-gray-50 text-gray-600 dark:bg-slate-800 dark:text-gray-300 border-transparent";
            let iconClass = "text-primary";
            
            if (currentPrio === 'tinggi') {
                 badgeClass = "bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-400 border-red-100 dark:border-red-900/30";
                 iconClass = "text-red-500";
            } else if (currentPrio === 'sedang') {
                 badgeClass = "bg-yellow-50 text-yellow-600 dark:bg-yellow-900/20 dark:text-yellow-400 border-yellow-100 dark:border-yellow-900/30";
                 iconClass = "text-yellow-500";
            } else if (currentPrio === 'telat') {
                 badgeClass = "bg-rose-50 text-rose-600 dark:bg-rose-900/20 dark:text-rose-400 border-rose-100 dark:border-rose-900/30";
                 iconClass = "text-rose-500";
            }

            badge.className = `flex items-center gap-2 px-3 py-1.5 rounded-lg transition-colors border ${badgeClass}`;
            icon.className = `fas fa-flag ${iconClass}`;
            text.textContent = styles.label;

            document.getElementById('detail-title').textContent = t.title;
            document.getElementById('detail-category').textContent = t.category;
            document.getElementById('detail-notes').textContent = t.notes || "-";
            
            const d = new Date(t.deadline);
            const dateStr = d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const timeStr = d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }).replace('.', ':');
            document.getElementById('detail-deadline').textContent = `${dateStr} pukul ${timeStr}`;

            const dateEl = document.getElementById('detail-deadline-wrapper');
            if (currentPrio === 'telat') {
                dateEl.classList.remove('bg-gray-50', 'dark:bg-slate-800');
                dateEl.classList.add('bg-rose-50', 'dark:bg-rose-900/20', 'text-rose-600', 'dark:text-rose-400');
            } else {
                dateEl.classList.add('bg-gray-50', 'dark:bg-slate-800');
                dateEl.classList.remove('bg-rose-50', 'dark:bg-rose-900/20', 'text-rose-600', 'dark:text-rose-400');
            }

            document.getElementById('btn-complete').onclick = () => markAsDone(t.id);
            document.getElementById('btn-gcal').onclick = () => addToGoogleCalendar(t);
            document.getElementById('btn-delete').onclick = () => deleteTask(t.id);
            openModal('modal-detail');
        }

        // ... (Other standard functions: markAsDone, delete, etc. same as before) ...
        function deleteTask(id) { if(confirm("Hapus?")) { state.tasks = state.tasks.filter(t => t.id !== id); saveTasks(); renderTasks(); renderCalendar(); closeModal('modal-detail'); } }
        
        function markAsDone(id) { 
            const t = state.tasks.find(x => x.id === id); 
            if(t) { 
                t.completed = true; 
                saveTasks(); 
                
                // --- LOGIKA POIN DINAMIS (UPDATED) ---
                // Hitung prioritas saat ini (real-time) untuk menentukan poin
                // Filosofi: Reward tertinggi untuk user yang mengerjakan jauh-jauh hari (Proaktif)
                const currentPriority = calculatePriority(t.deadline);
                let xpGained = 0;
                let message = "";

                if (currentPriority === 'rendah') {
                    xpGained = 200;
                    message = "Luar biasa! Kamu sangat terencana.";
                } else if (currentPriority === 'sedang') {
                    xpGained = 150;
                    message = "Kerja bagus! Tetap konsisten.";
                } else if (currentPriority === 'tinggi') {
                    xpGained = 100;
                    message = "Fuh! Untung selesai sebelum deadline.";
                } else { // Telat
                    xpGained = 50; 
                    message = "Lebih baik terlambat daripada tidak sama sekali.";
                }

                addXP(xpGained); 
                
                closeModal('modal-detail'); 
                
                // Update tampilan modal celebration
                const xpAnimEl = document.getElementById('xp-gain-anim');
                xpAnimEl.textContent = `+${xpGained} XP`;
                
                // Reset animasi agar bisa play ulang
                xpAnimEl.classList.remove('animate-bounce');
                void xpAnimEl.offsetWidth; // trigger reflow
                xpAnimEl.classList.add('animate-bounce');

                // Custom message berdasarkan poin
                const msgEl = document.getElementById('celebration-msg');
                msgEl.textContent = message;

                document.getElementById('modal-celebration').classList.remove('hidden'); 
                
                renderTasks(); 
                renderCalendar(); 
            } 
        }
        
        function closeCelebration() { document.getElementById('modal-celebration').classList.add('hidden'); }
        function addToGoogleCalendar(t) {
            const s = new Date(t.deadline).toISOString().replace(/-|:|\.\d\d\d/g, "");
            const e = new Date(new Date(t.deadline).getTime() + 3600000).toISOString().replace(/-|:|\.\d\d\d/g, "");
            window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t.title)}&dates=${s}/${e}&details=${encodeURIComponent(t.notes)}`, '_blank');
        }
        function renderCalendar() {
            const y = state.currentDate.getFullYear(), m = state.currentDate.getMonth();
            document.getElementById('calendar-month-year').textContent = new Date(y, m).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const grid = els.calendarBody; grid.innerHTML = '';
            const firstDay = new Date(y, m, 1).getDay(); const daysInMonth = new Date(y, m + 1, 0).getDate();
            for (let i=0; i<firstDay; i++) { const c = document.createElement('div'); c.className = "calendar-day bg-gray-50 dark:bg-slate-900/50 opacity-50"; grid.appendChild(c); }
            for (let d=1; d<=daysInMonth; d++) {
                const c = document.createElement('div'); c.className = "calendar-day relative cursor-pointer flex flex-col items-center justify-start";
                c.innerHTML = `<span class="text-xs font-bold p-1 text-gray-500 dark:text-gray-400">${d}</span>`;
                const today = new Date(); if (d === today.getDate() && m === today.getMonth() && y === today.getFullYear()) c.classList.add('ring-2', 'ring-primary');
                const tCount = state.tasks.filter(t => !t.completed && new Date(t.deadline).getDate()===d && new Date(t.deadline).getMonth()===m).length;
                if(tCount > 0) {
                    const dots = document.createElement('div'); dots.className = "flex gap-1 mt-1";
                    for(let k=0; k<Math.min(tCount, 3); k++) { const dot = document.createElement('span'); dot.className = "w-1.5 h-1.5 rounded-full bg-primary"; dots.appendChild(dot); }
                    c.appendChild(dots);
                }
                grid.appendChild(c);
            }
        }
        function changeMonth(o) { state.currentDate.setMonth(state.currentDate.getMonth() + o); renderCalendar(); }

        // --- UI UTILITIES (Unified Transitions) ---
        function updateSortOptions(view) {
            const select = document.getElementById('filter-sort');
            const currentVal = select.value;
            select.innerHTML = ''; 
            // Only add 'most_tasks' for folder view
            const opts = [
                {v:'deadline', t:'Deadline Terdekat'},
                {v:'alpha', t:'Abjad (A-Z)'}
            ];
            if(view === 'folder') opts.push({v:'most_tasks', t:'Tugas Terbanyak'});
            
            opts.forEach(o => {
                const op = document.createElement('option');
                op.value = o.v; op.text = o.t;
                select.appendChild(op);
            });
            
            if (select.querySelector(`option[value="${currentVal}"]`)) select.value = currentVal;
            else select.selectedIndex = 0;
            initCustomSelects();
        }

        function switchView(viewName) {
            const btnList = document.getElementById('btn-view-list');
            const btnFolder = document.getElementById('btn-view-folder');
            const btnCal = document.getElementById('btn-view-calendar');
            const viewList = document.getElementById('view-list');
            const viewCal = document.getElementById('view-calendar');
            const filterCont = document.getElementById('filter-container');
            
            updateSortOptions(viewName);

            [btnList, btnFolder, btnCal].forEach(btn => btn.className = "flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-gray-700 dark:hover:text-gray-300");
            state.viewMode = viewName;
            document.getElementById(`btn-view-${viewName}`).className = "flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white dark:bg-slate-700 text-primary shadow-sm";

            const containerList = document.getElementById('view-list');
            const containerCal = document.getElementById('view-calendar');
            
            // Determine Active & Next Container
            let activeContainer = !containerList.classList.contains('hidden') ? containerList : containerCal;
            let nextContainer = (viewName === 'calendar') ? containerCal : containerList;

            // Same transition classes for all views
            const hiddenState = ['opacity-0', 'scale-95'];
            const visibleState = ['opacity-100', 'scale-100'];

            // 1. Fade Out Active
            activeContainer.classList.remove(...visibleState);
            activeContainer.classList.add(...hiddenState);
            
            // Handle filter visibility
            if(viewName === 'calendar') {
                filterCont.classList.remove(...visibleState);
                filterCont.classList.add(...hiddenState);
            }

            setTimeout(() => {
                activeContainer.classList.add('hidden');
                nextContainer.classList.remove('hidden');
                
                if(viewName === 'calendar') {
                     filterCont.classList.add('hidden');
                } else {
                     filterCont.classList.remove('hidden');
                     // Force reflow/render before fading in filter
                     filterCont.classList.remove(...hiddenState); 
                     filterCont.classList.add(...visibleState);
                }

                if(viewName === 'calendar') renderCalendar();
                else renderTasks(); 

                // 2. Fade In Next
                requestAnimationFrame(() => {
                    nextContainer.classList.remove(...hiddenState);
                    nextContainer.classList.add(...visibleState);
                });
            }, 300); // 300ms matches CSS transition time
        }

        function toggleTheme() { state.darkMode = !state.darkMode; localStorage.setItem('focusTask_theme', state.darkMode ? 'dark':'light'); applyTheme(); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); if(id==='modal-add') renderCategoryOptions(); else initCustomSelects(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openAddTaskModal() { openModal('modal-add'); const n=new Date(); n.setMinutes(n.getMinutes()-n.getTimezoneOffset()+60); document.getElementById('task-deadline').value=n.toISOString().slice(0,16); updatePriorityPreview(); }
        
        // --- ADDED: Make sure page is loaded ---
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
