<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasking - Manajemen Tugas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        primary: { DEFAULT: 'var(--color-primary)', hover: 'var(--color-primary-hover)', light: 'var(--color-primary-light)' },
                        secondary: { DEFAULT: '#84cc16', hover: '#65a30d' },
                        dark: { bg: '#0f172a', surface: '#1e293b', text: '#f8fafc' },
                        light: { bg: '#f8fafc', surface: '#ffffff', text: '#0f172a' },
                        premium: { DEFAULT: '#f59e0b', light: '#fef3c7' }
                    },
                    animation: {
                        'bounce-short': 'bounce 1s infinite 2',
                    }
                }
            }
        }
    </script>
    <style>
        :root { --color-primary: #6366f1; --color-primary-hover: #4f46e5; --color-primary-light: #e0e7ff; }
        .theme-pink { --color-primary: #ec4899; --color-primary-hover: #db2777; --color-primary-light: #fce7f3; }
        .theme-orange { --color-primary: #f97316; --color-primary-hover: #ea580c; --color-primary-light: #ffedd5; }
        .theme-teal { --color-primary: #14b8a6; --color-primary-hover: #0d9488; --color-primary-light: #ccfbf1; }
        
        body { transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { min-height: 80px; border-radius: 12px; padding: 8px; transition: all 0.2s; background-color: rgba(255,255,255,0.5); border: 1px solid transparent; }
        .dark .calendar-day { background-color: rgba(30, 41, 59, 0.5); }
        .calendar-day:hover { background-color: var(--color-primary-light); transform: translateY(-2px); }
        .dark .calendar-day:hover { background-color: #334155; }
        .task-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin: 2px; }
        
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); }
        .custom-select-wrapper { position: relative; user-select: none; }
    </style>
</head>
<body class="bg-light-bg text-light-text dark:bg-dark-bg dark:text-dark-text min-h-screen flex flex-col font-sans selection:bg-primary selection:text-white">

    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none opacity-40 dark:opacity-20">
        <div class="absolute top-0 left-1/4 w-72 h-72 bg-primary rounded-full mix-blend-multiply filter blur-xl opacity-70"></div>
        <div class="absolute top-0 right-1/4 w-72 h-72 bg-secondary rounded-full mix-blend-multiply filter blur-xl opacity-70"></div>
    </div>

    <div id="main-app" class="flex flex-col h-screen overflow-hidden">
        <!-- Navbar -->
        <nav class="glass border-b border-gray-200/50 dark:border-gray-700/50 p-4 px-6 flex justify-between items-center z-20">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md">
                    <i class="fas fa-check-double"></i>
                </div>
                <div>
                    <h2 class="font-extrabold text-2xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-primary to-purple-600 cursor-pointer" onclick="togglePremiumStatus()">Tasking <span id="pro-badge" class="hidden text-[10px] bg-premium text-white px-1.5 py-0.5 rounded ml-1 align-top shadow-sm">PRO</span></h2>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <button onclick="openModal('modal-settings')" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-600 dark:text-gray-300 transition flex items-center justify-center">
                    <i class="fas fa-palette"></i>
                </button>
                <a href="about.html" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-600 dark:text-gray-300 transition flex items-center justify-center">
                    <i class="fas fa-question"></i>
                </a>
                <button onclick="openModal('modal-premium')" class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-500 text-white hover:scale-105 transition flex items-center justify-center shadow-lg shadow-yellow-500/30">
                    <i class="fas fa-crown"></i>
                </button>
            </div>
        </nav>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
            <div class="max-w-5xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-4">
                    <div>
                        <h1 class="text-4xl font-extrabold tracking-tight mb-2">Daftar Tugas</h1>
                        <div class="flex flex-wrap items-center gap-3 text-gray-500 dark:text-gray-400 font-medium">
                            <div class="flex items-center gap-3 bg-gray-100 dark:bg-slate-800/50 px-4 py-2 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm">
                                <span id="time-icon" class="text-2xl animate-pulse">‚òÄÔ∏è</span>
                                <span id="clock-display" class="font-mono text-xl tracking-wide text-gray-800 dark:text-gray-200 font-bold">00:00:00</span>
                            </div>
                            <span class="hidden md:inline text-gray-300 dark:text-gray-700 text-xl">|</span>
                            <span id="date-display" class="text-lg">Senin, 1 Januari 2024</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="openCategoryModal()" class="bg-primary-light text-primary hover:opacity-90 dark:bg-slate-800 dark:text-primary-light px-6 py-3 rounded-xl transition font-bold shadow-sm flex items-center gap-2">
                            <i class="fas fa-folder-plus"></i> <span class="hidden sm:inline">Kategori</span>
                        </button>
                        <button onclick="openAddTaskModal()" class="bg-primary hover:bg-primary-hover text-white px-6 py-3 rounded-xl shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:-translate-y-1 transition-all duration-300 flex items-center gap-2 font-bold">
                            <i class="fas fa-plus"></i> Tambah Tugas
                        </button>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-center bg-white dark:bg-dark-surface p-2 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-8 gap-4">
                    <div class="flex bg-gray-100 dark:bg-slate-900 p-1 rounded-xl w-full md:w-auto">
                        <button onclick="switchView('list')" id="btn-view-list" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white dark:bg-slate-700 text-primary">List Tugas</button>
                        <button onclick="switchView('folder')" id="btn-view-folder" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Kategori</button>
                        <button onclick="switchView('calendar')" id="btn-view-calendar" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Kalender</button>
                    </div>
                    <div id="filter-container" class="flex gap-3 items-center w-full md:w-auto px-2 relative z-30 transition-all duration-500 ease-in-out transform origin-right">
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Sort By:</span>
                        <div class="flex-1 md:w-48">
                             <select id="filter-sort" onchange="renderTasks()">
                                <option value="deadline">Deadline Terdekat</option>
                                <option value="alpha">Abjad (A-Z)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="view-list" class="transition-all duration-500 ease-in-out transform origin-top"></div>

                <div id="view-calendar" class="hidden bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 transition-all duration-500 ease-in-out transform origin-top opacity-0 scale-95">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2">
                            <button onclick="changeMonth(-1)" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center justify-center transition"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="calendar-month-year" class="font-bold text-xl min-w-[140px] text-center">Januari 2024</h3>
                            <button onclick="changeMonth(1)" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center justify-center transition"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <a href="https://calendar.google.com/" target="_blank" class="text-xs font-bold text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary transition flex items-center gap-2 bg-gray-50 dark:bg-slate-800 px-3 py-2 rounded-lg border border-gray-200 dark:border-slate-700">
                            <i class="fab fa-google"></i> Buka GCal
                        </a>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">
                        <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
                    </div>
                    <div id="calendar-body" class="calendar-grid"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-settings" class="fixed inset-0 z-[60] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-sm rounded-2xl shadow-2xl p-6 border border-gray-100 dark:border-gray-700 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Tampilan</h3>
                <button onclick="closeModal('modal-settings')" class="text-gray-400 hover:text-black dark:hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex justify-between items-center mb-6 p-4 bg-gray-50 dark:bg-slate-800 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-700 flex items-center justify-center shadow-sm"><i id="theme-modal-icon" class="fas fa-moon text-primary"></i></div>
                    <div><p class="font-bold text-sm">Mode Gelap</p><p class="text-xs text-gray-500">Nyaman di mata</p></div>
                </div>
                <button onclick="toggleTheme()" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-primary transition-colors">
                    <span id="dark-mode-toggle-circle" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1 dark:translate-x-6"></span>
                </button>
            </div>
            <div>
                <div class="flex justify-between items-center mb-3"><p class="font-bold text-sm">Warna Tema</p><span class="text-[10px] bg-premium text-white px-2 py-0.5 rounded font-bold">PRO</span></div>
                <div class="grid grid-cols-4 gap-3">
                    <button onclick="changeColorTheme('')" class="h-10 rounded-full bg-[#6366f1] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 dark:ring-offset-slate-800"></button>
                    <button onclick="changeColorTheme('theme-pink')" class="h-10 rounded-full bg-[#ec4899] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 dark:ring-offset-slate-800"></button>
                    <button onclick="changeColorTheme('theme-orange')" class="h-10 rounded-full bg-[#f97316] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 dark:ring-offset-slate-800"></button>
                    <button onclick="changeColorTheme('theme-teal')" class="h-10 rounded-full bg-[#14b8a6] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 dark:ring-offset-slate-800"></button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-category" class="fixed inset-0 z-[60] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-sm rounded-2xl shadow-2xl p-6 border border-gray-100 dark:border-gray-700 transform transition-all scale-100 relative overflow-hidden">
            <div id="premium-category-banner" class="hidden absolute top-0 left-0 right-0 bg-premium text-white text-xs font-bold text-center py-1">Kategori Penuh (3/3). Upgrade ke PRO!</div>
            <h3 class="text-xl font-bold mb-4 mt-2">Kelola Kategori</h3>
            <p id="category-limit-info" class="text-xs text-gray-500 mb-3">User Gratis: Maksimal 3 Kategori.</p>
            <div id="current-categories" class="flex flex-wrap gap-2 mb-4 max-h-32 overflow-y-auto"></div>
            <form id="add-category-form" class="mt-2">
                <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Kategori Baru</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="new-category-input" class="flex-1 p-2 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none transition font-medium text-sm" placeholder="Misal: Biologi" required>
                    <button type="submit" class="bg-black text-white dark:bg-white dark:text-black p-2 rounded-xl hover:opacity-80"><i class="fas fa-plus"></i></button>
                </div>
            </form>
            <button onclick="closeModal('modal-category')" class="w-full mt-4 py-2 text-gray-500 hover:text-black dark:hover:text-white font-bold text-sm">Tutup</button>
        </div>
    </div>

    <div id="modal-premium" class="fixed inset-0 z-[70] hidden bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-sm rounded-3xl shadow-2xl p-8 border-2 border-premium transform transition-all scale-100 text-center relative">
            <button onclick="closeModal('modal-premium')" class="absolute top-4 right-4 text-gray-400 hover:text-black dark:hover:text-white"><i class="fas fa-times"></i></button>
            <div class="w-16 h-16 bg-premium/20 text-premium rounded-full flex items-center justify-center mx-auto mb-4 text-3xl animate-bounce-short"><i class="fas fa-crown"></i></div>
            <h2 class="text-2xl font-black mb-2 text-gray-900 dark:text-white">Upgrade ke PRO</h2>
            <p class="text-gray-500 text-sm mb-6">Buka potensi penuh produktivitasmu.</p>
            <ul class="text-left space-y-3 mb-8 text-sm text-gray-600 dark:text-gray-300">
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Kategori Tanpa Batas</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Tema Warna Eksklusif</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Statistik Produktivitas</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Mode Fokus (Pomodoro)</li>
            </ul>
            <button onclick="activatePremium()" class="w-full py-3 bg-premium hover:bg-yellow-600 text-white font-bold rounded-xl shadow-lg shadow-premium/30 transition transform hover:scale-105">Dapatkan PRO - Rp 10.000/bln</button>
        </div>
    </div>

    <div id="modal-add" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-lg rounded-2xl shadow-2xl p-8 border border-gray-100 dark:border-gray-700 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-purple-600">Tugas Baru ‚ú®</h2>
                <button onclick="closeModal('modal-add')" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <form id="add-task-form" class="space-y-5">
                <div><label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Judul Tugas</label><input type="text" id="task-title" required class="w-full mt-2 p-3 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none transition font-medium" placeholder="Contoh: Makalah Sejarah"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Kategori</label><div class="mt-2"><select id="task-category" required class="w-full"></select></div></div>
                    <div><label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Deadline</label><input type="datetime-local" id="task-deadline" required onchange="updatePriorityPreview()" class="w-full mt-2 p-3 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none transition cursor-pointer font-medium dark:[color-scheme:dark]"></div>
                </div>
                <div class="bg-primary/5 border border-primary/20 p-4 rounded-xl flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center shadow-sm"><i class="fas fa-chart-line text-primary"></i></div>
                    <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Prioritas</p><p id="priority-preview" class="font-bold text-gray-700 dark:text-gray-200">Pilih deadline dulu...</p></div>
                </div>
                <div><label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Catatan</label><textarea id="task-notes" rows="3" class="w-full mt-2 p-3 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none resize-none font-medium" placeholder="Detail tugas..."></textarea></div>
                <div class="pt-4 flex justify-end gap-3"><button type="button" onclick="closeModal('modal-add')" class="px-6 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-800 transition">Batal</button><button type="submit" class="px-8 py-3 bg-primary hover:bg-primary-hover text-white font-bold rounded-xl shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:-translate-y-1 transition-all">Simpan</button></div>
            </form>
        </div>
    </div>

    <div id="modal-detail" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-md rounded-2xl shadow-2xl overflow-hidden border border-gray-100 dark:border-gray-700">
            <div class="p-8">
                <div class="flex justify-between items-start mb-4"><span id="detail-category" class="text-[10px] font-bold uppercase tracking-widest bg-primary/10 text-primary px-3 py-1 rounded-full">Kategori</span><button onclick="closeModal('modal-detail')" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button></div>
                <h2 id="detail-title" class="text-3xl font-extrabold mb-3 leading-tight">Judul Tugas</h2>
                <div class="flex flex-wrap gap-4 mb-6 text-sm text-gray-500 dark:text-gray-400">
                    <div class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 px-3 py-1.5 rounded-lg"><i class="far fa-clock text-primary"></i> <span id="detail-deadline" class="font-medium">Deadline</span></div>
                    <div class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 px-3 py-1.5 rounded-lg"><i class="fas fa-flag text-primary"></i> <span id="detail-priority" class="font-bold">Prioritas</span></div>
                </div>
                <div class="bg-gray-50 dark:bg-slate-900 p-5 rounded-2xl mb-8 border border-gray-100 dark:border-slate-800"><p id="detail-notes" class="text-sm whitespace-pre-wrap leading-relaxed text-gray-600 dark:text-gray-300">Tidak ada catatan.</p></div>
                <div class="space-y-3">
                    <button id="btn-gcal" class="w-full bg-white dark:bg-slate-800 border-2 border-gray-200 dark:border-slate-700 text-gray-700 dark:text-gray-200 py-3.5 rounded-xl font-bold hover:bg-gray-50 dark:hover:bg-slate-700 transition flex items-center justify-center gap-2 group"><i class="fab fa-google text-blue-500 group-hover:scale-110 transition"></i> Add to Google Calendar</button>
                    <button id="btn-complete" class="w-full bg-secondary hover:bg-secondary-hover text-white py-4 rounded-xl font-bold shadow-lg shadow-secondary/30 hover:shadow-secondary/50 hover:-translate-y-1 transition-all flex items-center justify-center gap-2 text-lg"><i class="fas fa-check-circle"></i> Mark as Done</button>
                    <button id="btn-delete" class="w-full text-red-400 text-sm py-2 hover:text-red-600 transition font-medium">Hapus Tugas</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-celebration" class="fixed inset-0 z-50 hidden bg-slate-900/90 backdrop-blur flex items-center justify-center p-4 text-center">
        <div class="transform transition-all animate-bounce-short">
            <div class="text-8xl mb-6 filter drop-shadow-lg">üéâ</div>
            <h2 class="text-4xl font-black mb-3 text-white">Slay! üî•</h2>
            <p id="celebration-msg" class="text-gray-300 mb-8 text-xl font-medium max-w-xs mx-auto">Tugas selesai.</p>
            <button onclick="closeCelebration()" class="px-10 py-4 bg-white text-primary font-bold rounded-full hover:scale-105 transition shadow-xl shadow-white/20">Lanjut Gan!</button>
        </div>
    </div>

    <script>
        const state = {
            tasks: JSON.parse(localStorage.getItem('focusTask_tasks')) || [],
            categories: JSON.parse(localStorage.getItem('focusTask_categories')) || ['Umum'],
            darkMode: localStorage.getItem('focusTask_theme') === 'dark',
            colorTheme: localStorage.getItem('focusTask_color') || '',
            viewMode: 'list', 
            currentDate: new Date(),
            currentTaskView: null,
            isPremium: localStorage.getItem('focusTask_premium') === 'true'
        };

        const els = {
            mainApp: document.getElementById('main-app'),
            addTaskForm: document.getElementById('add-task-form'),
            taskList: document.getElementById('view-list'),
            calendarView: document.getElementById('view-calendar'),
            calendarBody: document.getElementById('calendar-body'),
            dateDisplay: document.getElementById('date-display'),
            filterSort: document.getElementById('filter-sort'),
        };

        function checkPremiumFeature(featureName) {
            if (state.isPremium) return true;
            if (featureName === 'add_category' && state.categories.length >= 3) { openModal('modal-premium'); return false; }
            if (featureName === 'custom_theme') { openModal('modal-premium'); return false; }
            return true;
        }

        function activatePremium() {
            alert("Terima kasih! Anda sekarang user PRO. üéâ");
            state.isPremium = true;
            localStorage.setItem('focusTask_premium', 'true');
            closeModal('modal-premium');
            updateUIForPremium();
            if (!document.getElementById('modal-category').classList.contains('hidden')) openCategoryModal();
        }

        function updateUIForPremium() {
            const badge = document.getElementById('pro-badge');
            const limitInfo = document.getElementById('category-limit-info');
            const banner = document.getElementById('premium-category-banner');
            if (state.isPremium) {
                if (badge) badge.classList.remove('hidden');
                if (limitInfo) limitInfo.textContent = "User PRO: Kategori Tanpa Batas ‚ú®";
                if (banner) banner.classList.add('hidden');
            } else {
                if (badge) badge.classList.add('hidden');
                if (state.categories.length >= 3 && banner) banner.classList.remove('hidden');
            }
        }
        
        function togglePremiumStatus() {
            if(confirm("Dev Mode: Toggle Premium Status?")) {
                state.isPremium = !state.isPremium;
                localStorage.setItem('focusTask_premium', state.isPremium);
                location.reload();
            }
        }

        function changeColorTheme(themeName) {
            if (themeName && !checkPremiumFeature('custom_theme')) return;
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            if (themeName) document.body.classList.add(themeName);
            state.colorTheme = themeName;
            localStorage.setItem('focusTask_color', themeName);
        }

        function initCustomSelects() {
            document.querySelectorAll('.custom-select-wrapper').forEach(w => {
                const s = w.querySelector('select');
                if(s) { w.parentNode.insertBefore(s, w); s.style.display = 'block'; s.removeAttribute('data-customized'); }
                w.remove();
            });
            document.querySelectorAll('select').forEach(select => {
                if (select.dataset.customized === 'true') return;
                select.style.display = 'none';
                select.dataset.customized = 'true';
                const wrapper = document.createElement('div');
                wrapper.className = 'custom-select-wrapper relative w-full font-medium select-none';
                const trigger = document.createElement('div');
                trigger.className = "flex justify-between items-center cursor-pointer bg-gray-50 dark:bg-slate-900 border-2 border-transparent hover:border-primary/50 transition-all rounded-xl p-3 px-4 text-sm w-full outline-none";
                const displayText = select.options[select.selectedIndex] ? select.options[select.selectedIndex].text : "Pilih...";
                trigger.innerHTML = `<span class="truncate text-gray-700 dark:text-gray-200">${displayText}</span><i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-300"></i>`;
                const optionsDiv = document.createElement('div');
                optionsDiv.className = "absolute left-0 right-0 top-full mt-2 bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl shadow-xl z-[100] overflow-hidden hidden opacity-0 transform scale-95 transition-all duration-200 origin-top max-h-60 overflow-y-auto custom-scrollbar";
                Array.from(select.options).forEach(option => {
                    const div = document.createElement('div');
                    div.className = "px-4 py-3 cursor-pointer hover:bg-primary/10 hover:text-primary dark:hover:bg-slate-700 transition-colors text-sm text-gray-600 dark:text-gray-300 flex items-center justify-between";
                    div.innerHTML = `<span>${option.text}</span>`;
                    if (option.selected) div.classList.add('text-primary', 'bg-primary/5', 'font-bold');
                    div.addEventListener('click', (e) => {
                        e.stopPropagation();
                        select.value = option.value;
                        select.dispatchEvent(new Event('change'));
                        trigger.querySelector('span').textContent = option.text;
                        optionsDiv.classList.add('hidden');
                        optionsDiv.classList.remove('opacity-100', 'scale-100');
                    });
                    optionsDiv.appendChild(div);
                });
                trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isHidden = optionsDiv.classList.contains('hidden');
                    document.querySelectorAll('.custom-select-wrapper > div:last-child').forEach(d => d.classList.add('hidden'));
                    if (isHidden) {
                        optionsDiv.classList.remove('hidden');
                        requestAnimationFrame(() => { optionsDiv.classList.remove('opacity-0', 'scale-95'); optionsDiv.classList.add('opacity-100', 'scale-100'); });
                    }
                });
                wrapper.appendChild(select);
                wrapper.appendChild(trigger);
                wrapper.appendChild(optionsDiv);
                select.parentNode.insertBefore(wrapper, select);
            });
            document.addEventListener('click', () => document.querySelectorAll('.custom-select-wrapper > div:last-child').forEach(d => d.classList.add('hidden')));
        }

        function init() {
            applyTheme();
            if (state.colorTheme) document.body.classList.add(state.colorTheme);
            renderDate();
            renderTasks();
            renderCalendar();
            setTimeout(initCustomSelects, 100);
            setInterval(updateClockAndIcon, 1000);
            updateClockAndIcon();
            updateUIForPremium(); 
        }

        function updateClockAndIcon() {
            const now = new Date();
            const hour = now.getHours();
            document.getElementById('clock-display').textContent = now.toLocaleTimeString('id-ID', { hour12: false });
            let icon = 'üåô'; 
            if (hour >= 5 && hour < 11) icon = 'üåÖ'; 
            else if (hour >= 11 && hour < 15) icon = '‚òÄÔ∏è'; 
            else if (hour >= 15 && hour < 18) icon = 'üåá'; 
            document.getElementById('time-icon').textContent = icon;
        }

        function applyTheme() {
            const html = document.documentElement;
            state.darkMode ? html.classList.add('dark') : html.classList.remove('dark');
            const modalIcon = document.getElementById('theme-modal-icon');
            if (modalIcon) {
                if (state.darkMode) { modalIcon.classList.remove('fa-moon'); modalIcon.classList.add('fa-sun'); } 
                else { modalIcon.classList.remove('fa-sun'); modalIcon.classList.add('fa-moon'); }
            }
        }

        function openCategoryModal() {
            renderCategoryBadges();
            updateUIForPremium(); 
            openModal('modal-category');
        }

        function renderCategoryBadges() {
            const container = document.getElementById('current-categories');
            container.innerHTML = state.categories.length === 0 ? '<span class="text-xs text-gray-400 italic">Belum ada kategori</span>' : '';
            state.categories.forEach(cat => {
                const badge = document.createElement('div');
                badge.className = "bg-gray-100 dark:bg-slate-800 text-xs px-3 py-1 rounded-full flex items-center gap-2 border border-gray-200 dark:border-slate-700 select-none group hover:border-red-200 dark:hover:border-red-900 transition-colors";
                badge.innerHTML = `<span>${cat}</span><button type="button" class="text-gray-400 group-hover:text-red-500 transition-colors cursor-pointer"><i class="fas fa-times"></i></button>`;
                badge.querySelector('button').onclick = (e) => { e.preventDefault(); deleteCategory(cat); };
                container.appendChild(badge);
            });
        }

        function deleteCategory(cat) {
            const origLen = state.categories.length;
            state.categories = state.categories.filter(c => c !== cat);
            if (state.categories.length < origLen) {
                localStorage.setItem('focusTask_categories', JSON.stringify(state.categories));
                renderCategoryBadges(); renderCategoryOptions(); renderTasks(); updateUIForPremium(); 
            }
        }

        document.getElementById('add-category-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!checkPremiumFeature('add_category')) return;
            const input = document.getElementById('new-category-input');
            const newCat = input.value.trim();
            if (newCat && !state.categories.includes(newCat)) {
                state.categories.push(newCat);
                localStorage.setItem('focusTask_categories', JSON.stringify(state.categories));
                input.value = '';
                renderCategoryBadges(); renderCategoryOptions(); renderTasks(); updateUIForPremium();
            }
        });

        function renderCategoryOptions() {
            const select = document.getElementById('task-category');
            if (!select) return;
            select.innerHTML = '';
            state.categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat; opt.textContent = cat;
                select.appendChild(opt);
            });
            initCustomSelects();
        }

        function calculatePriority(d) {
            if(!d) return 'sedang';
            const diff = (new Date(d) - new Date()) / (1000 * 60 * 60 * 24);
            return diff < 3 ? 'tinggi' : (diff <= 7 ? 'sedang' : 'rendah');
        }

        function updatePriorityPreview() {
            const val = document.getElementById('task-deadline').value;
            const el = document.getElementById('priority-preview');
            if(!val) { el.textContent = "Pilih deadline dulu..."; el.className = "font-bold text-gray-700 dark:text-gray-200"; return; }
            const p = calculatePriority(val);
            let t = "Rendah üü¢", c = "text-green-500";
            if(p === 'tinggi') { t = "Tinggi üî¥"; c = "text-red-500"; }
            else if(p === 'sedang') { t = "Sedang üü°"; c = "text-yellow-500"; }
            el.textContent = t; el.className = `font-bold ${c}`;
        }

        els.addTaskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const d = document.getElementById('task-deadline').value;
            state.tasks.push({
                id: Date.now(),
                title: document.getElementById('task-title').value,
                category: document.getElementById('task-category').value,
                priority: calculatePriority(d),
                deadline: d,
                notes: document.getElementById('task-notes').value,
                completed: false
            });
            saveTasks(); renderTasks(); renderCalendar(); closeModal('modal-add'); els.addTaskForm.reset(); updatePriorityPreview();
        });

        function saveTasks() { localStorage.setItem('focusTask_tasks', JSON.stringify(state.tasks)); }

        function renderTasks() {
            const container = els.taskList;
            container.innerHTML = '';
            let tasks = state.tasks.filter(t => !t.completed);
            const sort = els.filterSort.value;

            if (tasks.length === 0 && state.viewMode !== 'folder') {
                container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 transition-all duration-500 ease-in-out transform origin-top";
                container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400"><div class="w-24 h-24 bg-gray-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4 text-4xl animate-bounce">üåµ</div><p class="font-medium">Belum ada tugas. Chill dulu!</p></div>`;
                return;
            }

            if (state.viewMode === 'folder') {
                container.className = "space-y-8 transition-all duration-500 ease-in-out transform origin-top pb-12";
                let cats = [...new Set([...state.categories, ...tasks.map(t => t.category)])].sort();
                cats.forEach(cat => {
                    const tInCat = tasks.filter(t => t.category === cat);
                    // Sort inside folder
                    tInCat.sort((a,b) => sort === 'deadline' ? new Date(a.deadline) - new Date(b.deadline) : a.title.localeCompare(b.title));
                    
                    const sec = document.createElement('div');
                    sec.className = "mb-8 border border-gray-200 dark:border-gray-700 rounded-3xl p-6 bg-white/50 dark:bg-slate-800/30";
                    sec.innerHTML = `<div class="bg-white dark:bg-dark-surface p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center justify-between mb-6"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-2xl bg-[#e0e7ff] dark:bg-slate-700/50 text-primary flex items-center justify-center text-xl"><i class="fas fa-folder"></i></div><h3 class="font-bold text-lg text-gray-800 dark:text-white">${cat}</h3></div><div class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 flex items-center justify-center font-bold text-sm">${tInCat.length}</div></div><div class="grid-container grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 pl-2"></div>`;
                    
                    const gc = sec.querySelector('.grid-container');
                    if(tInCat.length > 0) tInCat.forEach(t => gc.appendChild(createTaskCard(t)));
                    else { gc.className = "flex items-center justify-center py-8 bg-gray-50 dark:bg-slate-800/30 rounded-xl border-2 border-dashed border-gray-200 dark:border-slate-700/50"; gc.innerHTML = `<span class="text-sm text-gray-400 italic">Belum ada tugas di kategori ini</span>`; }
                    container.appendChild(sec);
                });
            } else {
                container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 transition-all duration-500 ease-in-out transform origin-top";
                tasks.sort((a,b) => sort === 'deadline' ? new Date(a.deadline) - new Date(b.deadline) : a.title.localeCompare(b.title));
                tasks.forEach(t => container.appendChild(createTaskCard(t)));
            }
        }

        function createTaskCard(t) {
            const d = new Date(t.deadline);
            let pc = "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400", pl = "RENDAH", dc = "bg-green-500";
            if(t.priority === 'sedang') { pc = "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400"; pl = "SEDANG"; dc = "bg-yellow-500"; }
            if(t.priority === 'tinggi') { pc = "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"; pl = "TINGGI"; dc = "bg-red-500"; }
            
            const c = document.createElement('div');
            c.className = "bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition-all duration-300 cursor-pointer group flex flex-col justify-between";
            c.onclick = () => openTaskDetail(t.id);
            c.innerHTML = `<div><div class="flex justify-between items-start mb-4"><span class="inline-block px-3 py-1 rounded-lg bg-[#e0e7ff] dark:bg-indigo-900/30 text-primary font-bold text-[10px] tracking-wider uppercase">${t.category}</span><span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full ${pc} text-[10px] font-bold uppercase tracking-wide"><span class="w-1.5 h-1.5 rounded-full ${dc}"></span> ${pl}</span></div><h3 class="font-extrabold text-xl text-gray-800 dark:text-gray-100 mb-6 leading-tight group-hover:text-primary transition-colors">${t.title}</h3></div><div class="pt-4 border-t border-gray-100 dark:border-gray-700 flex items-center gap-2 text-gray-500 dark:text-gray-400 text-sm font-medium"><i class="far fa-clock"></i><span>${d.toLocaleDateString('id-ID', {day:'numeric', month:'short'})}, ${d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}).replace('.',':')}</span></div>`;
            return c;
        }

        function openTaskDetail(id) {
            const t = state.tasks.find(x => x.id === id);
            if (!t) return;
            state.currentTaskView = t;
            document.getElementById('detail-title').textContent = t.title;
            document.getElementById('detail-category').textContent = t.category;
            document.getElementById('detail-notes').textContent = t.notes || "-";
            document.getElementById('detail-priority').textContent = "Priority: " + t.priority.toUpperCase();
            document.getElementById('detail-deadline').textContent = new Date(t.deadline).toLocaleString();
            document.getElementById('btn-complete').onclick = () => markAsDone(t.id);
            document.getElementById('btn-gcal').onclick = () => addToGoogleCalendar(t);
            document.getElementById('btn-delete').onclick = () => deleteTask(t.id);
            openModal('modal-detail');
        }

        function markAsDone(id) {
            const t = state.tasks.find(x => x.id === id);
            if(t) { t.completed = true; saveTasks(); closeModal('modal-detail'); document.getElementById('modal-celebration').classList.remove('hidden'); renderTasks(); renderCalendar(); }
        }

        function addToGoogleCalendar(t) {
            const s = new Date(t.deadline).toISOString().replace(/-|:|\.\d\d\d/g, "");
            const e = new Date(new Date(t.deadline).getTime() + 3600000).toISOString().replace(/-|:|\.\d\d\d/g, "");
            window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t.title)}&dates=${s}/${e}&details=${encodeURIComponent(t.notes)}`, '_blank');
        }

        function renderCalendar() {
            const y = state.currentDate.getFullYear(), m = state.currentDate.getMonth();
            document.getElementById('calendar-month-year').textContent = new Date(y, m).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const grid = els.calendarBody; grid.innerHTML = '';
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            
            for (let i=0; i<firstDay; i++) { const c = document.createElement('div'); c.className = "calendar-day bg-gray-50 dark:bg-slate-900/50 opacity-50"; grid.appendChild(c); }
            for (let d=1; d<=daysInMonth; d++) {
                const c = document.createElement('div'); c.className = "calendar-day relative cursor-pointer flex flex-col items-center justify-start";
                c.innerHTML = `<span class="text-xs font-bold p-1 text-gray-500 dark:text-gray-400">${d}</span>`;
                const today = new Date();
                if (d === today.getDate() && m === today.getMonth() && y === today.getFullYear()) c.classList.add('ring-2', 'ring-primary');
                
                const tCount = state.tasks.filter(t => !t.completed && new Date(t.deadline).getDate()===d && new Date(t.deadline).getMonth()===m).length;
                if(tCount > 0) {
                    const dots = document.createElement('div'); dots.className = "flex gap-1 mt-1";
                    for(let k=0; k<Math.min(tCount, 3); k++) { const dot = document.createElement('span'); dot.className = "w-1.5 h-1.5 rounded-full bg-primary"; dots.appendChild(dot); }
                    c.appendChild(dots);
                }
                grid.appendChild(c);
            }
        }

        function changeMonth(o) { state.currentDate.setMonth(state.currentDate.getMonth() + o); renderCalendar(); }

        function switchView(v) {
            state.viewMode = v;
            document.querySelectorAll('#btn-view-list, #btn-view-folder, #btn-view-calendar').forEach(b => b.className = "flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-gray-700 dark:hover:text-gray-300");
            document.getElementById(`btn-view-${v}`).className = "flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white dark:bg-slate-700 text-primary shadow-sm";
            
            els.taskList.classList.add('hidden'); els.calendarView.classList.add('hidden'); document.getElementById('filter-container').classList.remove('hidden');
            
            if(v === 'calendar') { 
                els.calendarView.classList.remove('hidden'); 
                document.getElementById('filter-container').classList.add('hidden');
                renderCalendar(); 
            } else { 
                els.taskList.classList.remove('hidden'); 
                renderTasks(); 
            }
        }

        function toggleTheme() { state.darkMode = !state.darkMode; localStorage.setItem('focusTask_theme', state.darkMode ? 'dark':'light'); applyTheme(); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); if(id==='modal-add') renderCategoryOptions(); else initCustomSelects(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function closeCelebration() { document.getElementById('modal-celebration').classList.add('hidden'); }
    </script>
</body>
</html>