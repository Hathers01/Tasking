<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusTask - Manajemen Tugas</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        primary: {
                            DEFAULT: 'var(--color-primary)', 
                            hover: 'var(--color-primary-hover)',
                            light: 'var(--color-primary-light)', 
                        },
                        secondary: {
                            DEFAULT: '#84cc16', // Lime
                            hover: '#65a30d',
                        },
                        dark: {
                            bg: '#0f172a', 
                            surface: '#1e293b',
                            text: '#f8fafc',
                        },
                        light: {
                            bg: '#f8fafc',
                            surface: '#ffffff',
                            text: '#0f172a',
                        },
                        premium: {
                            DEFAULT: '#f59e0b',
                            light: '#fef3c7'
                        }
                    },
                    animation: {
                        'bounce-short': 'bounce 1s infinite 2',
                        'blob': 'blob 7s infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* DEFINISI WARNA DINAMIS */
        :root {
            --color-primary: #6366f1;
            --color-primary-hover: #4f46e5;
            --color-primary-light: #e0e7ff;
        }

        .theme-pink {
            --color-primary: #ec4899;
            --color-primary-hover: #db2777;
            --color-primary-light: #fce7f3;
        }
        .theme-orange {
            --color-primary: #f97316;
            --color-primary-hover: #ea580c;
            --color-primary-light: #ffedd5;
        }
        .theme-teal {
            --color-primary: #14b8a6;
            --color-primary-hover: #0d9488;
            --color-primary-light: #ccfbf1;
        }
        .theme-blue {
            --color-primary: #3b82f6;
            --color-primary-hover: #2563eb;
            --color-primary-light: #dbeafe;
        }

        .dark .glass {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { min-height: 80px; border-radius: 12px; padding: 8px; transition: all 0.2s; background-color: rgba(255,255,255,0.5); border: 1px solid transparent; }
        .dark .calendar-day { background-color: rgba(30, 41, 59, 0.5); }
        .calendar-day:hover { background-color: var(--color-primary-light); transform: translateY(-2px); }
        .dark .calendar-day:hover { background-color: #334155; }
        .task-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin: 2px; }
        
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        
        .custom-select-wrapper { position: relative; user-select: none; }
        
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms ease-out, transform 300ms ease-out; }
        .fade-exit { opacity: 1; transform: translateY(0); }
        .fade-exit-active { opacity: 0; transform: translateY(-10px); transition: opacity 300ms ease-in, transform 300ms ease-in; }
    </style>
</head>
<body class="bg-light-bg text-light-text dark:bg-dark-bg dark:text-dark-text min-h-screen flex flex-col font-sans selection:bg-primary selection:text-white">

    <!-- Decorative Blobs -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none opacity-40 dark:opacity-20">
        <div class="absolute top-0 left-1/4 w-72 h-72 bg-primary rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-72 h-72 bg-secondary rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-1/3 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-4000"></div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="flex flex-col h-screen overflow-hidden">
        
        <!-- Navbar -->
        <nav class="glass border-b border-gray-200/50 dark:border-gray-700/50 p-4 px-6 flex justify-between items-center z-20">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md" id="user-avatar">
                    <i class="fas fa-check-double"></i>
                </div>
                <div>
                    <h2 class="font-extrabold text-2xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-primary to-purple-600 cursor-pointer" onclick="togglePremiumStatus()">FocusTask <span id="pro-badge" class="hidden text-[10px] bg-premium text-white px-1.5 py-0.5 rounded ml-1 align-top shadow-sm">PRO</span></h2>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <button onclick="openModal('modal-settings')" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-600 dark:text-gray-300 transition flex items-center justify-center" title="Pengaturan Tampilan">
                    <i class="fas fa-palette"></i>
                </button>
                <a href="about.html" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-600 dark:text-gray-300 transition flex items-center justify-center" title="About / Bantuan">
                    <i class="fas fa-question"></i>
                </a>
                <button onclick="openModal('modal-premium')" class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-500 text-white hover:scale-105 transition flex items-center justify-center shadow-lg shadow-yellow-500/30" title="Berlangganan Premium">
                    <i class="fas fa-crown"></i>
                </button>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
            
            <div class="max-w-5xl mx-auto">
                <!-- Header Actions -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-4">
                    <div>
                        <h1 class="text-4xl font-extrabold tracking-tight mb-2">Daftar Tugas</h1>
                        <!-- Clock & Date Section -->
                        <div class="flex flex-wrap items-center gap-3 text-gray-500 dark:text-gray-400 font-medium">
                            <div class="flex items-center gap-3 bg-gray-100 dark:bg-slate-800/50 px-4 py-2 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm transition-all hover:scale-105 cursor-default">
                                <span id="time-icon" class="text-2xl animate-pulse">‚òÄÔ∏è</span>
                                <span id="clock-display" class="font-mono text-xl tracking-wide text-gray-800 dark:text-gray-200 font-bold">00:00:00</span>
                            </div>
                            <span class="hidden md:inline text-gray-300 dark:text-gray-700 text-xl">|</span>
                            <span id="date-display" class="text-lg">Senin, 1 Januari 2024</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="openCategoryModal()" class="bg-primary-light text-primary hover:opacity-90 dark:bg-slate-800 dark:text-primary-light px-6 py-3 rounded-xl transition font-bold shadow-sm flex items-center gap-2" title="Kelola Kategori">
                            <i class="fas fa-folder-plus"></i> <span class="hidden sm:inline">Kategori</span>
                        </button>
                        <button onclick="openAddTaskModal()" class="bg-primary hover:bg-primary-hover text-white px-6 py-3 rounded-xl shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:-translate-y-1 transition-all duration-300 flex items-center gap-2 font-bold">
                            <i class="fas fa-plus"></i> Tambah Tugas
                        </button>
                    </div>
                </div>

                <!-- Tabs & Filter -->
                <div class="flex flex-col md:flex-row justify-between items-center bg-white dark:bg-dark-surface p-2 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-8 gap-4">
                    <div class="flex bg-gray-100 dark:bg-slate-900 p-1 rounded-xl w-full md:w-auto">
                        <button onclick="switchView('list')" id="btn-view-list" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white dark:bg-slate-700 text-primary">List Tugas</button>
                        <button onclick="switchView('folder')" id="btn-view-folder" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Kategori</button>
                        <button onclick="switchView('calendar')" id="btn-view-calendar" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Kalender</button>
                    </div>
                    
                    <div id="filter-container" class="flex gap-3 items-center w-full md:w-auto px-2 relative z-30 transition-all duration-500 ease-in-out transform origin-right">
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Sort By:</span>
                        <div class="flex-1 md:w-48">
                             <select id="filter-sort" onchange="renderTasks()">
                                <option value="deadline">Deadline Terdekat</option>
                                <option value="alpha">Abjad (A-Z)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- LIST VIEW -->
                <div id="view-list" class="transition-all duration-500 ease-in-out transform origin-top"></div>

                <!-- CALENDAR VIEW -->
                <div id="view-calendar" class="hidden bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 transition-all duration-500 ease-in-out transform origin-top opacity-0 scale-95">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2">
                            <button onclick="changeMonth(-1)" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center justify-center transition"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="calendar-month-year" class="font-bold text-xl min-w-[140px] text-center">Januari 2024</h3>
                            <button onclick="changeMonth(1)" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center justify-center transition"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <a href="https://calendar.google.com/" target="_blank" class="text-xs font-bold text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary transition flex items-center gap-2 bg-gray-50 dark:bg-slate-800 px-3 py-2 rounded-lg border border-gray-200 dark:border-slate-700">
                            <i class="fab fa-google"></i> Buka GCal
                        </a>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">
                        <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
                    </div>
                    <div id="calendar-body" class="calendar-grid"></div>
                    <div class="mt-6 flex gap-4 text-xs font-medium justify-center">
                         <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-400"></span> Tinggi</div>
                         <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-400"></span> Sedang</div>
                         <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-400"></span> Rendah</div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL: SETTINGS -->
    <div id="modal-settings" class="fixed inset-0 z-[60] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-sm rounded-2xl shadow-2xl p-6 border border-gray-100 dark:border-gray-700 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Tampilan</h3>
                <button onclick="closeModal('modal-settings')" class="text-gray-400 hover:text-black dark:hover:text-white"><i class="fas fa-times"></i></button>
            </div>

            <!-- Dark Mode Toggle -->
            <div class="flex justify-between items-center mb-6 p-4 bg-gray-50 dark:bg-slate-800 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-700 flex items-center justify-center shadow-sm">
                        <i id="theme-modal-icon" class="fas fa-moon text-primary"></i>
                    </div>
                    <div>
                        <p class="font-bold text-sm">Mode Gelap</p>
                        <p class="text-xs text-gray-500">Nyaman di mata</p>
                    </div>
                </div>
                <button onclick="toggleTheme()" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-primary transition-colors">
                    <span class="sr-only">Toggle dark mode</span>
                    <span id="dark-mode-toggle-circle" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1 dark:translate-x-6"></span>
                </button>
            </div>

            <!-- Color Theme Picker -->
            <div>
                <div class="flex justify-between items-center mb-3">
                    <p class="font-bold text-sm">Warna Tema</p>
                    <span class="text-[10px] bg-premium text-white px-2 py-0.5 rounded font-bold">PRO</span>
                </div>
                <div class="grid grid-cols-4 gap-3">
                    <button onclick="changeColorTheme('')" class="h-10 rounded-full bg-[#6366f1] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 focus:ring-black dark:ring-offset-slate-800"></button>
                    <button onclick="changeColorTheme('theme-pink')" class="h-10 rounded-full bg-[#ec4899] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 focus:ring-black dark:ring-offset-slate-800"></button>
                    <button onclick="changeColorTheme('theme-orange')" class="h-10 rounded-full bg-[#f97316] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 focus:ring-black dark:ring-offset-slate-800"></button>
                    <button onclick="changeColorTheme('theme-teal')" class="h-10 rounded-full bg-[#14b8a6] ring-2 ring-offset-2 ring-transparent hover:ring-gray-300 focus:ring-black dark:ring-offset-slate-800"></button>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">Pilih warna aksen favoritmu.</p>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD CATEGORY -->
    <div id="modal-category" class="fixed inset-0 z-[60] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-sm rounded-2xl shadow-2xl p-6 border border-gray-100 dark:border-gray-700 transform transition-all scale-100 relative overflow-hidden">
            <!-- Premium Banner -->
            <div id="premium-category-banner" class="hidden absolute top-0 left-0 right-0 bg-premium text-white text-xs font-bold text-center py-1">
                Kategori Penuh (3/3). Upgrade ke PRO!
            </div>

            <h3 class="text-xl font-bold mb-4 mt-2">Kelola Kategori</h3>
            <p id="category-limit-info" class="text-xs text-gray-500 mb-3">User Gratis: Maksimal 3 Kategori.</p>
            
            <div id="current-categories" class="flex flex-wrap gap-2 mb-4 max-h-32 overflow-y-auto"></div>
            
            <form id="add-category-form" class="mt-2">
                <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Kategori Baru</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="new-category-input" class="flex-1 p-2 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none transition font-medium text-sm" placeholder="Misal: Biologi" required>
                    <button type="submit" class="bg-black text-white dark:bg-white dark:text-black p-2 rounded-xl hover:opacity-80"><i class="fas fa-plus"></i></button>
                </div>
            </form>
            
            <button onclick="closeModal('modal-category')" class="w-full mt-4 py-2 text-gray-500 hover:text-black dark:hover:text-white font-bold text-sm">Tutup</button>
        </div>
    </div>

    <!-- MODAL: PREMIUM UPSELL -->
    <div id="modal-premium" class="fixed inset-0 z-[70] hidden bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-sm rounded-3xl shadow-2xl p-8 border-2 border-premium transform transition-all scale-100 text-center relative">
            <button onclick="closeModal('modal-premium')" class="absolute top-4 right-4 text-gray-400 hover:text-black dark:hover:text-white"><i class="fas fa-times"></i></button>
            
            <div class="w-16 h-16 bg-premium/20 text-premium rounded-full flex items-center justify-center mx-auto mb-4 text-3xl animate-bounce-short">
                <i class="fas fa-crown"></i>
            </div>
            
            <h2 class="text-2xl font-black mb-2 text-gray-900 dark:text-white">Upgrade ke PRO</h2>
            <p class="text-gray-500 text-sm mb-6">Buka potensi penuh produktivitasmu.</p>
            
            <ul class="text-left space-y-3 mb-8 text-sm text-gray-600 dark:text-gray-300">
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Kategori Tanpa Batas</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Tema Warna Eksklusif</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Statistik Produktivitas</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> Mode Fokus (Pomodoro)</li>
            </ul>
            
            <button onclick="activatePremium()" class="w-full py-3 bg-premium hover:bg-yellow-600 text-white font-bold rounded-xl shadow-lg shadow-premium/30 transition transform hover:scale-105">
                Dapatkan PRO - Rp 10.000/bln
            </button>
        </div>
    </div>

    <!-- MODAL: ADD TASK -->
    <div id="modal-add" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-lg rounded-2xl shadow-2xl p-8 border border-gray-100 dark:border-gray-700 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-purple-600">Tugas Baru ‚ú®</h2>
                <button onclick="closeModal('modal-add')" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="add-task-form" class="space-y-5">
                <div>
                    <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Judul Tugas</label>
                    <input type="text" id="task-title" required class="w-full mt-2 p-3 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none transition font-medium" placeholder="Contoh: Makalah Sejarah">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Kategori</label>
                        <div class="mt-2">
                            <select id="task-category" required class="w-full">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Deadline</label>
                        <input type="datetime-local" id="task-deadline" required onchange="updatePriorityPreview()" class="w-full mt-2 p-3 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none transition cursor-pointer font-medium dark:[color-scheme:dark]">
                    </div>
                </div>

                <div class="bg-primary/5 border border-primary/20 p-4 rounded-xl flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center shadow-sm">
                        <i class="fas fa-chart-line text-primary"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Prioritas</p>
                        <p id="priority-preview" class="font-bold text-gray-700 dark:text-gray-200">Pilih deadline dulu...</p>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold uppercase tracking-wider text-gray-500 ml-1">Catatan</label>
                    <textarea id="task-notes" rows="3" class="w-full mt-2 p-3 bg-gray-50 dark:bg-slate-900 border-2 border-transparent focus:border-primary rounded-xl outline-none resize-none font-medium" placeholder="Detail tugas..."></textarea>
                </div>

                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('modal-add')" class="px-6 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-800 transition">Batal</button>
                    <button type="submit" class="px-8 py-3 bg-primary hover:bg-primary-hover text-white font-bold rounded-xl shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:-translate-y-1 transition-all">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: TASK DETAIL -->
    <div id="modal-detail" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-md rounded-2xl shadow-2xl overflow-hidden border border-gray-100 dark:border-gray-700">
            <div class="p-8">
                <div class="flex justify-between items-start mb-4">
                    <span id="detail-category" class="text-[10px] font-bold uppercase tracking-widest bg-primary/10 text-primary px-3 py-1 rounded-full">Kategori</span>
                    <button onclick="closeModal('modal-detail')" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
                </div>
                <h2 id="detail-title" class="text-3xl font-extrabold mb-3 leading-tight">Judul Tugas</h2>
                
                <div class="flex flex-wrap gap-4 mb-6 text-sm text-gray-500 dark:text-gray-400">
                    <div class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 px-3 py-1.5 rounded-lg">
                        <i class="far fa-clock text-primary"></i> <span id="detail-deadline" class="font-medium">Deadline</span>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 px-3 py-1.5 rounded-lg">
                        <i class="fas fa-flag text-primary"></i> <span id="detail-priority" class="font-bold">Prioritas</span>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-slate-900 p-5 rounded-2xl mb-8 border border-gray-100 dark:border-slate-800">
                    <p id="detail-notes" class="text-sm whitespace-pre-wrap leading-relaxed text-gray-600 dark:text-gray-300">Tidak ada catatan.</p>
                </div>

                <div class="space-y-3">
                    <button id="btn-gcal" class="w-full bg-white dark:bg-slate-800 border-2 border-gray-200 dark:border-slate-700 text-gray-700 dark:text-gray-200 py-3.5 rounded-xl font-bold hover:bg-gray-50 dark:hover:bg-slate-700 transition flex items-center justify-center gap-2 group">
                        <i class="fab fa-google text-blue-500 group-hover:scale-110 transition"></i> Add to Google Calendar
                    </button>
                    <button id="btn-complete" class="w-full bg-secondary hover:bg-secondary-hover text-white py-4 rounded-xl font-bold shadow-lg shadow-secondary/30 hover:shadow-secondary/50 hover:-translate-y-1 transition-all flex items-center justify-center gap-2 text-lg">
                        <i class="fas fa-check-circle"></i> Mark as Done
                    </button>
                    <button id="btn-delete" class="w-full text-red-400 text-sm py-2 hover:text-red-600 transition font-medium">
                        Hapus Tugas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CELEBRATION -->
    <div id="modal-celebration" class="fixed inset-0 z-50 hidden bg-slate-900/90 backdrop-blur flex items-center justify-center p-4 text-center">
        <div class="transform transition-all animate-bounce-short">
            <div class="text-8xl mb-6 filter drop-shadow-lg">üéâ</div>
            <h2 class="text-4xl font-black mb-3 text-white">Slay! üî•</h2>
            <p id="celebration-msg" class="text-gray-300 mb-8 text-xl font-medium max-w-xs mx-auto">Tugas selesai. Kamu keren banget hari ini.</p>
            <button onclick="closeCelebration()" class="px-10 py-4 bg-white text-primary font-bold rounded-full hover:scale-105 transition shadow-xl shadow-white/20">
                Lanjut Gan!
            </button>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            tasks: JSON.parse(localStorage.getItem('focusTask_tasks')) || [],
            categories: JSON.parse(localStorage.getItem('focusTask_categories')) || ['Umum'],
            darkMode: localStorage.getItem('focusTask_theme') === 'dark',
            colorTheme: localStorage.getItem('focusTask_color') || '',
            viewMode: 'list', 
            currentDate: new Date(),
            currentTaskView: null,
            isPremium: localStorage.getItem('focusTask_premium') === 'true'
        };

        // --- DOM ELEMENTS ---
        const els = {
            mainApp: document.getElementById('main-app'),
            addTaskForm: document.getElementById('add-task-form'),
            taskList: document.getElementById('view-list'),
            calendarView: document.getElementById('view-calendar'),
            calendarBody: document.getElementById('calendar-body'),
            dateDisplay: document.getElementById('date-display'),
            filterSort: document.getElementById('filter-sort'),
        };

        // --- FREEMIUM LOGIC ---
        function checkPremiumFeature(featureName) {
            if (state.isPremium) return true;
            if (featureName === 'add_category') {
                if (state.categories.length >= 3) {
                    openModal('modal-premium');
                    return false;
                }
            }
            if (featureName === 'custom_theme') {
                openModal('modal-premium');
                return false;
            }
            return true;
        }

        function activatePremium() {
            alert("Terima kasih! Anda sekarang user PRO. üéâ");
            state.isPremium = true;
            localStorage.setItem('focusTask_premium', 'true');
            closeModal('modal-premium');
            updateUIForPremium();
            if (!document.getElementById('modal-category').classList.contains('hidden')) {
                openCategoryModal();
            }
        }

        function updateUIForPremium() {
            const badge = document.getElementById('pro-badge');
            const limitInfo = document.getElementById('category-limit-info');
            const banner = document.getElementById('premium-category-banner');
            if (state.isPremium) {
                if (badge) badge.classList.remove('hidden');
                if (limitInfo) limitInfo.textContent = "User PRO: Kategori Tanpa Batas ‚ú®";
                if (banner) banner.classList.add('hidden');
            } else {
                if (badge) badge.classList.add('hidden');
                if (state.categories.length >= 3 && banner) banner.classList.remove('hidden');
            }
        }
        
        function togglePremiumStatus() {
            if(confirm("Dev Mode: Toggle Premium Status?")) {
                state.isPremium = !state.isPremium;
                localStorage.setItem('focusTask_premium', state.isPremium);
                location.reload();
            }
        }

        // --- THEME & COLOR ---
        function changeColorTheme(themeName) {
            if (themeName && !checkPremiumFeature('custom_theme')) return;
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            if (themeName) document.body.classList.add(themeName);
            state.colorTheme = themeName;
            localStorage.setItem('focusTask_color', themeName);
        }

        // --- CUSTOM SELECT LOGIC (GEN Z STYLE) ---
        function initCustomSelects() {
            const wrappers = document.querySelectorAll('.custom-select-wrapper');
            wrappers.forEach(wrapper => {
                const select = wrapper.querySelector('select');
                if(select) {
                    wrapper.parentNode.insertBefore(select, wrapper);
                    select.style.display = 'block';
                    select.removeAttribute('data-customized'); 
                }
                wrapper.remove(); 
            });

            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                if (select.dataset.customized === 'true') return;
                select.style.display = 'none';
                select.dataset.customized = 'true';
                const wrapper = document.createElement('div');
                wrapper.className = 'custom-select-wrapper relative w-full font-medium select-none';
                const trigger = document.createElement('div');
                const baseClasses = "flex justify-between items-center cursor-pointer bg-gray-50 dark:bg-slate-900 border-2 border-transparent hover:border-primary/50 transition-all rounded-xl p-3 px-4 text-sm w-full outline-none";
                trigger.className = baseClasses;
                const selectedOption = select.options[select.selectedIndex];
                const displayText = selectedOption ? selectedOption.text : "Pilih...";
                trigger.innerHTML = `
                    <span class="truncate text-gray-700 dark:text-gray-200 ${!selectedOption || selectedOption.value === "" ? "text-gray-400 dark:text-gray-500" : ""}">${displayText}</span>
                    <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-300"></i>
                `;
                const optionsDiv = document.createElement('div');
                optionsDiv.className = "absolute left-0 right-0 top-full mt-2 bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl shadow-xl z-[100] overflow-hidden hidden opacity-0 transform scale-95 transition-all duration-200 origin-top max-h-60 overflow-y-auto custom-scrollbar";
                Array.from(select.options).forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = "px-4 py-3 cursor-pointer hover:bg-primary/10 hover:text-primary dark:hover:bg-slate-700 transition-colors text-sm text-gray-600 dark:text-gray-300 flex items-center justify-between";
                    optionDiv.innerHTML = `<span>${option.text}</span>`;
                    if (option.selected) {
                        optionDiv.classList.add('text-primary', 'bg-primary/5', 'font-bold');
                        optionDiv.innerHTML += `<i class="fas fa-check text-xs"></i>`;
                    }
                    optionDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        select.value = option.value;
                        select.dispatchEvent(new Event('change')); 
                        const span = trigger.querySelector('span');
                        span.textContent = option.text;
                        if (option.value !== "") span.classList.remove('text-gray-400', 'dark:text-gray-500');
                        else span.classList.add('text-gray-400', 'dark:text-gray-500');
                        optionsDiv.querySelectorAll('div').forEach(div => {
                             div.className = "px-4 py-3 cursor-pointer hover:bg-primary/10 hover:text-primary dark:hover:bg-slate-700 transition-colors text-sm text-gray-600 dark:text-gray-300 flex items-center justify-between";
                             const check = div.querySelector('.fa-check');
                             if(check) check.remove();
                        });
                        optionDiv.classList.add('text-primary', 'bg-primary/5', 'font-bold');
                        optionDiv.innerHTML += `<i class="fas fa-check text-xs"></i>`;
                        toggleMenu(false);
                    });
                    optionsDiv.appendChild(optionDiv);
                });
                let isOpen = false;
                function toggleMenu(state) {
                    if (state !== false) {
                         document.querySelectorAll('.custom-dropdown-options').forEach(el => {
                             if(el !== optionsDiv) {
                                 el.classList.add('hidden', 'opacity-0', 'scale-95');
                                 const otherTrigger = el.parentElement.querySelector('.fa-chevron-down');
                                 if(otherTrigger) otherTrigger.classList.remove('rotate-180');
                             }
                         });
                    }
                    isOpen = state !== undefined ? state : !isOpen;
                    if (isOpen) {
                        optionsDiv.classList.remove('hidden');
                        requestAnimationFrame(() => {
                            optionsDiv.classList.remove('opacity-0', 'scale-95');
                            optionsDiv.classList.add('opacity-100', 'scale-100');
                        });
                        trigger.querySelector('.fa-chevron-down').classList.add('rotate-180');
                        trigger.classList.add('border-primary/50', 'ring-2', 'ring-primary/20'); 
                    } else {
                        optionsDiv.classList.remove('opacity-100', 'scale-100');
                        optionsDiv.classList.add('opacity-0', 'scale-95');
                        trigger.querySelector('.fa-chevron-down').classList.remove('rotate-180');
                        trigger.classList.remove('border-primary/50', 'ring-2', 'ring-primary/20');
                        setTimeout(() => {
                            if (!isOpen) optionsDiv.classList.add('hidden');
                        }, 200);
                    }
                }
                optionsDiv.classList.add('custom-dropdown-options');
                trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMenu();
                });
                select.parentNode.insertBefore(wrapper, select);
                wrapper.appendChild(select);
                wrapper.appendChild(trigger);
                wrapper.appendChild(optionsDiv);
                document.addEventListener('click', (e) => {
                    if (!wrapper.contains(e.target)) {
                        toggleMenu(false);
                    }
                });
            });
        }

        // --- INITIALIZATION ---
        function init() {
            applyTheme();
            if (state.colorTheme) document.body.classList.add(state.colorTheme);
            renderDate();
            showMainApp();
            setInterval(updateClockAndIcon, 1000);
            updateClockAndIcon();
            updateUIForPremium(); 
        }

        function updateClockAndIcon() {
            const now = new Date();
            const hour = now.getHours();
            const timeString = now.toLocaleTimeString('id-ID', { hour12: false });
            document.getElementById('clock-display').textContent = timeString;
            const iconEl = document.getElementById('time-icon');
            let icon = 'üåô'; 
            if (hour >= 5 && hour < 11) icon = 'üåÖ'; 
            else if (hour >= 11 && hour < 15) icon = '‚òÄÔ∏è'; 
            else if (hour >= 15 && hour < 18) icon = 'üåá'; 
            else if (hour >= 18 || hour < 5) icon = 'üåô'; 
            iconEl.textContent = icon;
        }

        // --- APPLY THEME ---
        function applyTheme() {
            const html = document.documentElement;
            if (state.darkMode) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            const modalIcon = document.getElementById('theme-modal-icon');
            if (modalIcon) {
                if (state.darkMode) {
                    modalIcon.classList.remove('fa-moon');
                    modalIcon.classList.add('fa-sun');
                } else {
                    modalIcon.classList.remove('fa-sun');
                    modalIcon.classList.add('fa-moon');
                }
            }
        }

        function showMainApp() {
            els.mainApp.classList.remove('hidden');
            els.mainApp.classList.add('flex');
            renderTasks();
            renderCalendar();
            setTimeout(initCustomSelects, 100); 
        }

        // --- CATEGORY MANAGEMENT ---
        function openCategoryModal() {
            renderCategoryBadges();
            updateUIForPremium(); 
            openModal('modal-category');
        }

        function renderCategoryBadges() {
            const container = document.getElementById('current-categories');
            container.innerHTML = '';
            if (state.categories.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-400 italic">Belum ada kategori</span>';
            }
            state.categories.forEach(cat => {
                const badge = document.createElement('div');
                badge.className = "bg-gray-100 dark:bg-slate-800 text-xs px-3 py-1 rounded-full flex items-center gap-2 border border-gray-200 dark:border-slate-700 select-none group hover:border-red-200 dark:hover:border-red-900 transition-colors";
                const span = document.createElement('span');
                span.textContent = cat;
                const btn = document.createElement('button');
                btn.type = "button"; 
                btn.className = "text-gray-400 group-hover:text-red-500 transition-colors cursor-pointer";
                btn.innerHTML = '<i class="fas fa-times"></i>';
                btn.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    deleteCategory(cat);
                });
                badge.appendChild(span);
                badge.appendChild(btn);
                container.appendChild(badge);
            });
        }

        function deleteCategory(cat) {
            const originalLength = state.categories.length;
            state.categories = state.categories.filter(c => c !== cat);
            if (state.categories.length < originalLength) {
                localStorage.setItem('focusTask_categories', JSON.stringify(state.categories));
                renderCategoryBadges(); 
                renderCategoryOptions(); 
                renderTasks(); 
                updateUIForPremium(); 
            }
        }

        document.getElementById('add-category-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!checkPremiumFeature('add_category')) return;
            const input = document.getElementById('new-category-input');
            const newCat = input.value.trim();
            if (newCat && !state.categories.includes(newCat)) {
                state.categories.push(newCat);
                localStorage.setItem('focusTask_categories', JSON.stringify(state.categories));
                input.value = '';
                renderCategoryBadges();
                renderCategoryOptions(); 
                renderTasks();
                updateUIForPremium();
            }
        });

        function renderCategoryOptions() {
            const select = document.getElementById('task-category');
            if (!select) return;
            select.innerHTML = '';
            state.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
            initCustomSelects();
        }

        // --- AUTO PRIORITY LOGIC ---
        function calculatePriority(deadlineString) {
            if(!deadlineString) return 'sedang';
            const now = new Date();
            const deadline = new Date(deadlineString);
            const diffMs = deadline - now;
            const diffDays = diffMs / (1000 * 60 * 60 * 24);
            if (diffDays < 3) return 'tinggi'; 
            if (diffDays <= 7) return 'sedang'; 
            return 'rendah'; 
        }

        function updatePriorityPreview() {
            const dateVal = document.getElementById('task-deadline').value;
            const previewEl = document.getElementById('priority-preview');
            if(!dateVal) {
                previewEl.textContent = "Pilih deadline dulu...";
                previewEl.className = "font-bold text-gray-700 dark:text-gray-200";
                return;
            }
            const priority = calculatePriority(dateVal);
            let text = "";
            let color = "";
            if(priority === 'tinggi') {
                text = "Tinggi üî¥";
                color = "text-red-500";
            } else if (priority === 'sedang') {
                text = "Sedang üü°";
                color = "text-yellow-500";
            } else {
                text = "Rendah üü¢";
                color = "text-green-500";
            }
            previewEl.textContent = text;
            previewEl.className = `font-bold ${color}`;
        }

        // --- TASK MANAGEMENT ---
        els.addTaskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const deadlineVal = document.getElementById('task-deadline').value;
            const autoPriority = calculatePriority(deadlineVal);
            const newTask = {
                id: Date.now(),
                title: document.getElementById('task-title').value,
                category: document.getElementById('task-category').value,
                priority: autoPriority, 
                deadline: deadlineVal,
                notes: document.getElementById('task-notes').value,
                completed: false,
                createdAt: new Date().toISOString(),
                sentAlerts: [] 
            };
            state.tasks.push(newTask);
            saveTasks();
            renderTasks();
            renderCalendar();
            closeModal('modal-add');
            els.addTaskForm.reset();
            updatePriorityPreview(); 
        });

        function saveTasks() {
            localStorage.setItem('focusTask_tasks', JSON.stringify(state.tasks));
        }

        // --- RENDER TASKS ---
        function renderTasks() {
            const container = els.taskList;
            container.innerHTML = '';
            let displayTasks = state.tasks.filter(t => !t.completed);
            const sortType = els.filterSort.value;
            if (displayTasks.length === 0 && state.viewMode !== 'folder') {
                container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 transition-all duration-500 ease-in-out transform origin-top";
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400">
                        <div class="w-24 h-24 bg-gray-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4 text-4xl animate-bounce">üåµ</div>
                        <p class="font-medium">Belum ada tugas. Chill dulu!</p>
                    </div>`;
                return;
            }
            if (state.viewMode === 'folder') {
                container.className = "space-y-8 transition-all duration-500 ease-in-out transform origin-top pb-12"; 
                let relevantCategories = [...new Set([...state.categories, ...displayTasks.map(t => t.category)])];
                relevantCategories.sort((a, b) => {
                    if (sortType === 'alpha') return a.localeCompare(b);
                    if (sortType === 'deadline') {
                        const tasksA = displayTasks.filter(t => t.category === a);
                        const minDateA = tasksA.length > 0 ? Math.min(...tasksA.map(t => new Date(t.deadline).getTime())) : Infinity;
                        const tasksB = displayTasks.filter(t => t.category === b);
                        const minDateB = tasksB.length > 0 ? Math.min(...tasksB.map(t => new Date(t.deadline).getTime())) : Infinity;
                        if (minDateA === minDateB) return a.localeCompare(b);
                        return minDateA - minDateB;
                    }
                    return 0;
                });
                relevantCategories.forEach(cat => {
                    const tasksInCat = displayTasks.filter(t => t.category === cat);
                    tasksInCat.sort((a, b) => {
                        if (sortType === 'deadline') return new Date(a.deadline) - new Date(b.deadline);
                        if (sortType === 'alpha') return a.title.localeCompare(b.title);
                        return 0;
                    });
                    const section = document.createElement('div');
                    section.className = "mb-8 border border-gray-200 dark:border-gray-700 rounded-3xl p-6 bg-white/50 dark:bg-slate-800/30";
                    const headerHTML = `
                        <div class="bg-white dark:bg-dark-surface p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center justify-between mb-6 transition-all hover:shadow-md cursor-default">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-2xl bg-[#e0e7ff] dark:bg-slate-700/50 text-primary flex items-center justify-center text-xl">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <h3 class="font-bold text-lg text-gray-800 dark:text-white">${cat}</h3>
                            </div>
                            <div class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 flex items-center justify-center font-bold text-sm">
                                ${tasksInCat.length}
                            </div>
                        </div>
                    `;
                    section.innerHTML = headerHTML + `
                        <div class="grid-container grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 pl-2"></div>
                    `;
                    const gridContainer = section.querySelector('.grid-container');
                    if (tasksInCat.length > 0) {
                        tasksInCat.forEach(task => {
                            gridContainer.appendChild(createTaskCard(task));
                        });
                    } else {
                        gridContainer.classList.remove('grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3');
                        gridContainer.className = "flex items-center justify-center py-8 bg-gray-50 dark:bg-slate-800/30 rounded-xl border-2 border-dashed border-gray-200 dark:border-slate-700/50";
                        gridContainer.innerHTML = `<span class="text-sm text-gray-400 italic">Belum ada tugas di kategori ini</span>`;
                    }
                    container.appendChild(section);
                });
            } else {
                container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 transition-all duration-500 ease-in-out transform origin-top";
                displayTasks.sort((a, b) => {
                    if (sortType === 'deadline') return new Date(a.deadline) - new Date(b.deadline);
                    if (sortType === 'alpha') return a.title.localeCompare(b.title);
                    return 0;
                });
                displayTasks.forEach(task => {
                    container.appendChild(createTaskCard(task));
                });
            }
        }

        // Helper to create card DOM
        function createTaskCard(task) {
            const dateObj = new Date(task.deadline);
            const dateStr = dateObj.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' });
            const timeStr = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }).replace('.', ':');
            let priorityClass = "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400";
            let priorityLabel = "RENDAH";
            let dotColor = "bg-green-500";
            if(task.priority === 'sedang') {
                priorityClass = "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400";
                priorityLabel = "SEDANG";
                dotColor = "bg-yellow-500";
            }
            if(task.priority === 'tinggi') {
                priorityClass = "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400";
                priorityLabel = "TINGGI";
                dotColor = "bg-red-500";
            }
            const card = document.createElement('div');
            card.className = "bg-white dark:bg-dark-surface p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition-all duration-300 cursor-pointer group flex flex-col justify-between";
            card.onclick = () => openTaskDetail(task.id);
            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-4">
                        <span class="inline-block px-3 py-1 rounded-lg bg-[#e0e7ff] dark:bg-indigo-900/30 text-primary font-bold text-[10px] tracking-wider uppercase">
                            ${task.category}
                        </span>
                        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full ${priorityClass} text-[10px] font-bold uppercase tracking-wide">
                            <span class="w-1.5 h-1.5 rounded-full ${dotColor}"></span> ${priorityLabel}
                        </span>
                    </div>
                    <h3 class="font-extrabold text-xl text-gray-800 dark:text-gray-100 mb-6 leading-tight group-hover:text-primary transition-colors">
                        ${task.title}
                    </h3>
                </div>
                <div class="pt-4 border-t border-gray-100 dark:border-gray-700 flex items-center gap-2 text-gray-500 dark:text-gray-400 text-sm font-medium">
                    <i class="far fa-clock"></i>
                    <span>${dateStr}, ${timeStr}</span>
                </div>
            `;
            return card;
        }

        function openTaskDetail(id) {
            const task = state.tasks.find(t => t.id === id);
            if (!task) return;
            state.currentTaskView = task;
            document.getElementById('detail-title').textContent = task.title;
            document.getElementById('detail-category').textContent = task.category;
            document.getElementById('detail-notes').textContent = task.notes || "Tidak ada catatan tambahan.";
            document.getElementById('detail-priority').textContent = "Priority: " + task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            const dateObj = new Date(task.deadline);
            document.getElementById('detail-deadline').textContent = dateObj.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute:'2-digit' });
            const btnComplete = document.getElementById('btn-complete');
            btnComplete.onclick = () => markAsDone(task.id);
            const btnGcal = document.getElementById('btn-gcal');
            btnGcal.onclick = () => addToGoogleCalendar(task);
            const btnDelete = document.getElementById('btn-delete');
            btnDelete.onclick = () => deleteTask(task.id);
            openModal('modal-detail');
        }

        function deleteTask(id) {
            if(confirm("Hapus tugas ini?")) {
                state.tasks = state.tasks.filter(t => t.id !== id);
                saveTasks();
                renderTasks();
                renderCalendar();
                closeModal('modal-detail');
            }
        }

        function markAsDone(id) {
            const task = state.tasks.find(t => t.id === id);
            if(task) {
                task.completed = true;
                saveTasks();
                closeModal('modal-detail');
                const msg = document.getElementById('celebration-msg');
                const messages = [
                    "Slay! Satu tugas beres. ‚ú®",
                    "Main character energy banget! üíÖ",
                    "Keep up the grind! üî•",
                    "Rebahan time sebentar lagi. üò¥"
                ];
                msg.textContent = messages[Math.floor(Math.random() * messages.length)];
                const modal = document.getElementById('modal-celebration');
                modal.classList.remove('hidden');
                renderTasks();
                renderCalendar();
            }
        }

        function closeCelebration() {
            document.getElementById('modal-celebration').classList.add('hidden');
        }

        function addToGoogleCalendar(task) {
            const startDate = new Date(task.deadline);
            const endDate = new Date(startDate.getTime() + 60*60000);
            const formatGCalDate = (date) => {
                return date.toISOString().replace(/-|:|\.\d\d\d/g, "");
            };
            const startStr = formatGCalDate(startDate);
            const endStr = formatGCalDate(endDate);
            const details = encodeURIComponent(`Priority: ${task.priority}\nNotes: ${task.notes || '-'}`);
            const text = encodeURIComponent(`[Task] ${task.title}`);
            const location = encodeURIComponent(task.category);
            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${startStr}/${endStr}&details=${details}&location=${location}`;
            window.open(url, '_blank');
        }

        // --- CALENDAR LOGIC ---
        function renderCalendar() {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            document.getElementById('calendar-month-year').textContent = new Date(year, month).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const firstDay = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = els.calendarBody;
            grid.innerHTML = '';
            for (let i = 0; i < firstDay; i++) {
                const cell = document.createElement('div');
                cell.className = "calendar-day bg-gray-50 dark:bg-slate-900/50 opacity-50"; 
                grid.appendChild(cell);
            }
            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = "calendar-day relative cursor-pointer flex flex-col items-center justify-start";
                cell.innerHTML = `<span class="text-xs font-bold p-1 text-gray-500 dark:text-gray-400">${d}</span>`;
                const tasksForDay = state.tasks.filter(t => {
                    const tDate = new Date(t.deadline);
                    return !t.completed && tDate.getDate() === d && tDate.getMonth() === month && tDate.getFullYear() === year;
                });
                if (tasksForDay.length > 0) {
                    const dotContainer = document.createElement('div');
                    dotContainer.className = "flex flex-wrap gap-1 px-1 mt-1 justify-center";
                    tasksForDay.forEach(t => {
                        const dot = document.createElement('span');
                        dot.className = "task-dot";
                        if(t.priority === 'tinggi') dot.classList.add('bg-red-400');
                        else if(t.priority === 'sedang') dot.classList.add('bg-yellow-400');
                        else dot.classList.add('bg-green-400');
                        dotContainer.appendChild(dot);
                    });
                    cell.appendChild(dotContainer);
                    cell.title = `${tasksForDay.length} Tugas:\n` + tasksForDay.map(t => `- ${t.title}`).join('\n');
                }
                const today = new Date();
                if (d === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    cell.classList.add('ring-2', 'ring-primary', 'ring-offset-2', 'dark:ring-offset-slate-800');
                    cell.querySelector('span').classList.add('text-primary');
                }
                grid.appendChild(cell);
            }
        }

        function changeMonth(offset) {
            state.currentDate.setMonth(state.currentDate.getMonth() + offset);
            renderCalendar();
        }

        // --- UI UTILITIES ---
        function switchView(viewName) {
            const btnList = document.getElementById('btn-view-list');
            const btnFolder = document.getElementById('btn-view-folder');
            const btnCal = document.getElementById('btn-view-calendar');
            const viewList = document.getElementById('view-list');
            const viewCal = document.getElementById('view-calendar');
            const filterCont = document.getElementById('filter-container');
            [btnList, btnFolder, btnCal].forEach(btn => {
                btn.className = "flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-gray-500 hover:text-gray-700 dark:hover:text-gray-300";
            });
            state.viewMode = viewName;
            const activeBtn = viewName === 'list' ? btnList : (viewName === 'folder' ? btnFolder : btnCal);
            activeBtn.classList.remove('text-gray-500', 'hover:text-gray-700', 'dark:hover:text-gray-300');
            activeBtn.classList.add('bg-white', 'dark:bg-slate-700', 'text-primary', 'shadow-sm');
            const hiddenState = ['opacity-0', 'scale-95', 'pointer-events-none'];
            const visibleState = ['opacity-100', 'scale-100'];
            if (viewName === 'calendar') {
                viewList.classList.remove(...visibleState);
                viewList.classList.add(...hiddenState);
                filterCont.classList.remove(...visibleState);
                filterCont.classList.add(...hiddenState);
                setTimeout(() => {
                    viewList.classList.add('hidden'); 
                    filterCont.classList.add('hidden'); 
                    viewCal.classList.remove('hidden');
                    renderCalendar();
                    requestAnimationFrame(() => {
                        viewCal.classList.remove(...hiddenState);
                        viewCal.classList.add(...visibleState);
                    });
                }, 300);
            } else {
                viewCal.classList.remove(...visibleState);
                viewCal.classList.add(...hiddenState);
                setTimeout(() => {
                    viewCal.classList.add('hidden');
                    viewList.classList.remove('hidden');
                    filterCont.classList.remove('hidden');
                    renderTasks(); 
                    requestAnimationFrame(() => {
                        viewList.classList.remove(...hiddenState);
                        viewList.classList.add(...visibleState);
                        filterCont.classList.remove(...hiddenState);
                        filterCont.classList.add(...visibleState);
                    });
                }, 300);
            }
        }

        function toggleTheme() {
            state.darkMode = !state.darkMode;
            localStorage.setItem('focusTask_theme', state.darkMode ? 'dark' : 'light');
            applyTheme();
        }

        function applyTheme() {
            const html = document.documentElement;
            if (state.darkMode) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            const modalIcon = document.getElementById('theme-modal-icon');
            if (modalIcon) {
                if (state.darkMode) {
                    modalIcon.classList.remove('fa-moon');
                    modalIcon.classList.add('fa-sun');
                } else {
                    modalIcon.classList.remove('fa-sun');
                    modalIcon.classList.add('fa-moon');
                }
            }
        }

        function renderDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            els.dateDisplay.textContent = new Date().toLocaleDateString('id-ID', options);
        }

        // --- MODAL UTILITIES ---
        function openModal(id) {
            const el = document.getElementById(id);
            if(el) {
                el.classList.remove('hidden');
                if(id === 'modal-add') renderCategoryOptions();
                else initCustomSelects(); 
            }
        }
        function closeModal(id) {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        }
        function openAddTaskModal() {
            openModal('modal-add');
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset() + 60);
            document.getElementById('task-deadline').value = now.toISOString().slice(0, 16);
            updatePriorityPreview(); 
        }

        init();

    </script>
</body>
</html>